FROM ollama/ollama:latest

# Check if ollama user exists, if not create it
RUN id -u ollama &>/dev/null || (groupadd -f -g 1000 ollama && useradd -m -u 1000 -g ollama -s /bin/bash ollama)

# Create necessary directories and set permissions
RUN mkdir -p /root/.ollama /usr/share/ollama/.ollama /home/ollama/.ollama && \
    chown -R ollama:ollama /root/.ollama /usr/share/ollama/.ollama /home/ollama/.ollama 2>/dev/null || \
    chown -R $(id -u ollama):$(id -g ollama) /root/.ollama /usr/share/ollama/.ollama /home/ollama/.ollama

# Set the models you want to pre-load
ARG MODELS="gemma3:4b qwen3-vl:4b-instruct qwen3-embedding:0.6b qwen3-vl:2b-instruct"

# Switch to ollama user
USER ollama

# Start Ollama server, pull each model, then stop the server
RUN ollama serve & \
    sleep 5 && \
    for MODEL in $MODELS; do \
        echo "Pulling $MODEL..." && \
        ollama pull $MODEL; \
    done && \
    pkill ollama

# Expose the standard port
EXPOSE 11434

# Use the base image's default entrypoint
ENTRYPOINT ["ollama", "serve"]
