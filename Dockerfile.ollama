FROM ollama/ollama:latest

# 1. Create a system user 'ollama'
# -m creates the home directory
# -u 1000 sets a standard UID
RUN useradd -m -u 1001 ollama

# 2. Prepare the directory where models are stored
# By default, Ollama uses /root/.ollama. We change it to the new home directory.
ENV OLLAMA_MODELS=/home/ollama/.ollama/models
RUN mkdir -p /home/ollama/.ollama/models /.ollama /.ollama/models && \
    chown -R ollama:ollama /home/ollama/ /.ollama /.ollama/models

# 3. Switch to the non-root user
USER ollama

# 4. Set the working directory
WORKDIR /home/ollama

RUN pwd
RUN whoami

# Expose the default port
EXPOSE 11434

# Ensure the server listens on all interfaces
ENV OLLAMA_HOST=0.0.0.0

ENTRYPOINT ["ollama", "serve"]