FROM ollama/ollama:latest

# Set environment
ENV OLLAMA_MODELS=/.ollama/models

# Create user if it doesn't exist, suppress errors if it does
RUN (groupadd -g 1000 ollama 2>/dev/null || true) && \
    (useradd -u 1000 -g 1000 -m -s /bin/bash ollama 2>/dev/null || true)

# Create necessary directories and set permissions
RUN mkdir -p /.ollama /.ollama/models /home/ollama/.ollama && \
    chown -R 1000:1000 /.ollama /.ollama/models /home/ollama 2>/dev/null || true

# Set the models you want to pre-load
# ARG MODELS="gemma3:4b qwen3-vl:4b-instruct qwen3-embedding:0.6b qwen3-vl:2b-instruct"

# Switch to UID 1000
USER 1000

# Start Ollama server, pull each model, then stop the server
# RUN ollama serve & \
#     sleep 10 && \
#     for MODEL in $MODELS; do \
#         echo "Pulling $MODEL..." && \
#         ollama pull $MODEL; \
#     done && \
#     pkill ollama

RUN ollama serve & \
    pkill ollama

# Expose the standard port
EXPOSE 11434

# Use the base image's default entrypoint
ENTRYPOINT ["ollama", "serve"]
