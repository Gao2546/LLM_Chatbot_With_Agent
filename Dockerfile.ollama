FROM ollama/ollama:latest

# Add Google DNS configuration
RUN echo "nameserver 8.8.8.8" > /etc/resolv.conf && \
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf && \
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf

ENV OLLAMA_MODELS=/.ollama/models
ENV HOME=/home/ollama

# Create directories with OpenShift-compatible permissions
# chmod g=u allows any UID in group 0 (root group) to access
RUN mkdir -p /.ollama \
             /.ollama/models \
             /home/ollama/.ollama && \
    chgrp -R 0 /.ollama /home/ollama && \
    chmod -R g=u /.ollama /home/ollama && \
    chmod -R 775 /.ollama /home/ollama

RUN apt update && \
    apt install curl -y

# 2. Create startup script using printf (Fixes the "SET" error)
RUN printf '#!/bin/bash\n\
set -e\n\
ollama serve &\n\
OLLAMA_PID=$!\n\
echo "Waiting for Ollama to start..."\n\
until curl -s localhost:11434/api/tags > /dev/null; do sleep 2; done\n\
\n\
MODELS="gemma3:4b qwen3-vl:4b-instruct qwen3-embedding:0.6b qwen3-vl:2b-instruct"\n\
\n\
for MODEL in $MODELS; do\n\
    if ! ollama list | grep -q "$MODEL"; then\n\
        echo "Pulling $MODEL..."\n\
        ollama pull $MODEL || echo "Warning: Failed to pull $MODEL"\n\
    else\n\
        echo "$MODEL already exists"\n\
    fi\ndone\n\
echo "Ollama is ready!"\n\
wait $OLLAMA_PID' > /usr/local/bin/docker-entrypoint.sh

RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chgrp 0 /usr/local/bin/docker-entrypoint.sh && \
    chmod g=u /usr/local/bin/docker-entrypoint.sh

EXPOSE 11434

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
