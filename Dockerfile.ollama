FROM ollama/ollama:latest

ENV OLLAMA_MODELS=/.ollama/models
ENV HOME=/home/ollama

# Create directories with OpenShift-compatible permissions
# chmod g=u allows any UID in group 0 (root group) to access
RUN mkdir -p /.ollama \
             /.ollama/models \
             /home/ollama/.ollama && \
    chgrp -R 0 /.ollama /home/ollama && \
    chmod -R g=u /.ollama /home/ollama && \
    chmod -R 775 /.ollama /home/ollama

# Create startup script
RUN cat > /usr/local/bin/docker-entrypoint.sh <<'EOF'
#!/bin/bash
set -e

# Models to pull
MODELS="gemma3:4b qwen3-vl:4b-instruct qwen3-embedding:0.6b qwen3-vl:2b-instruct"

# Start ollama in background
ollama serve &
OLLAMA_PID=$!

# Wait for ollama to be ready
echo "Waiting for Ollama to start..."
sleep 10

# Pull models if they don't exist
for MODEL in $MODELS; do
    if ! ollama list 2>/dev/null | grep -q "$MODEL"; then
        echo "Pulling $MODEL..."
        ollama pull $MODEL || echo "Warning: Failed to pull $MODEL"
    else
        echo "$MODEL already exists"
    fi
done

echo "Ollama is ready!"

# Keep ollama running
wait $OLLAMA_PID
EOF

RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chgrp 0 /usr/local/bin/docker-entrypoint.sh && \
    chmod g=u /usr/local/bin/docker-entrypoint.sh

EXPOSE 11434

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
