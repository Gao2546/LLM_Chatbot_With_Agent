<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Create Question - Q&A Community</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712108.png">
    <link rel="stylesheet" href="community.css?v=5.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <!-- Auth Container (Top Right) -->
    <div class="auth-container">
        <span id="usernameDisplay" style="display: none; margin-right: 10px;"></span>
        <a href="auth/login" class="login-button" id="loginBtn">Login</a>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div id="chatList">
            <div class="btn-sidebar-container"></div>
            
            <!-- Infineon Logo -->
            <div class="sidebar-logo">
                <img src="image.png" alt="Infineon Logo" class="infineon-logo">
            </div>
            
            <!-- Navigation -->
            <a href="/" class="community-nav-button">
                <i class="fas fa-robot"></i> AI Chat
            </a>
            <a href="/community.html" class="community-nav-button" style="margin-top: 10px;">
                <i class="fas fa-comments"></i> Q&A Community
            </a>

            <!-- Filter By Section -->
            <div class="sidebar-section">
                <div class="section-title">Filter By</div>
                <a href="/community.html" class="sidebar-link">All questions</a>
                <a href="/community.html" class="sidebar-link">My Questions</a>
                <a href="/community.html" class="sidebar-link">My Answers</a>
                <a href="/community.html" class="sidebar-link">Pending review</a>
                <a href="/community.html" class="sidebar-link">Unverified</a>
            </div>

            <!-- Tags Section -->
            <div class="sidebar-section">
                <div class="section-title">Tags</div>
                <div id="tagsList" class="sidebar-tags-grid">
                    <span class="sidebar-tag-item" data-tag="PRVX 4">PRVX 4</span>
                    <span class="sidebar-tag-item" data-tag="D1">D1</span>
                    <span class="sidebar-tag-item" data-tag="Handler">Handler</span>
                    <span class="sidebar-tag-item" data-tag="V9300">V9300</span>
                    <span class="sidebar-tag-item" data-tag="Prober">Prober</span>
                    <span class="sidebar-tag-item" data-tag="Tester">Tester</span>
                    <span class="sidebar-tag-item" data-tag="AI">AI</span>
                    <span class="sidebar-tag-item" data-tag="Sensor">Sensor</span>
                </div>
            </div>

            <!-- Theme Toggle Button -->
            <div class="theme-toggle-container">
                <button id="themeToggleBtn" class="theme-toggle-btn" title="Change Theme">
                    <i class="fas fa-palette"></i>
                    <span id="themeLabel">Dark</span>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="chatbox">
            <!-- Header -->
            <h1 class="header1">
                <button id="toggleSidebarButton"><i class="fas fa-bars"></i></button>
                Create Question
            </h1>

            <!-- Content -->
            <div class="contain-overflow">
                <div class="content-wrapper" style="max-width: 900px; margin: 0 auto; padding: 20px;">

                    <!-- Title Field -->
                    <div class="form-section">
                        <label class="form-label">
                            Title<span style="color: red;">*</span>
                        </label>
                        <p class="form-hint">Be specific and imagine you're asking a question to another person.</p>
                        <input type="text" id="questionTitle" class="form-input" placeholder="e.g. How to optimize database queries?">
                    </div>

                    <!-- Body Field -->
                    <div class="form-section">
                        <label class="form-label">
                            Body<span style="color: red;">*</span>
                        </label>
                        <p class="form-hint">Include all the information someone would need to answer your question.</p>
                        <div style="flex: 1;">
                            <textarea id="questionBody" class="form-textarea" placeholder="Include details about your question..."></textarea>
                        </div>
                    </div>

                    <!-- File Upload Button (Between Body and Tags) -->
                    <div class="form-section">
                        <input type="file" id="fileInput" multiple style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                        <label for="fileInput" class="file-upload-btn-small" title="Attach files to your question">
                            <i class="fas fa-paperclip"></i> Attach Files
                        </label>
                        <!-- Selected Files List -->
                        <div id="filesList" style="display: none; margin-top: 12px;">
                            <!-- Files will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Tags Field -->
                    <div class="form-section">
                        <div style="margin-top: 0;">
                            <label class="form-label-tags">
                                <i class="fas fa-tags" style="margin-right: 6px;"></i>Add Tags
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="questionTags" class="form-input-tags" placeholder="Type tag name and press Enter or click +">
                                <button type="button" id="addTagBtn" class="form-add-tag-btn">
                                    <i class="fas fa-plus"></i>
                                    <span>Add</span>
                                </button>
                            </div>
                            <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;"></div>
                        </div>
                    </div>

                    <!-- Verification Type Selection -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-shield-check" style="margin-right: 6px; color: #017374;"></i>
                            Verification
                        </label>
                        
                        <div class="verification-cards-container">
                            <!-- Card 1: Self Verification -->
                            <div class="verification-card verification-card-active" id="selfCard" onclick="selectVerificationCard('self')">
                                <input type="radio" name="verificationType" value="self" checked style="display: none;">
                                <div class="verification-card-header">
                                    <i class="fas fa-building" style="color: #017374; font-size: 20px;"></i>
                                    <span class="verification-card-title">Verified by my department</span>
                                </div>
                                <div id="selfDepartmentsContainer" class="verification-card-content" style="display: block;">
                                    <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px; display: block;">Select department:</label>
                                    <select id="selfDepartmentSelect" class="verification-select">
                                        <option value="">Select department</option>
                                        <!-- Will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>

                            <!-- Card 2: Request Verification -->
                            <div class="verification-card" id="requestCard" onclick="selectVerificationCard('request')">
                                <input type="radio" name="verificationType" value="request" style="display: none;">
                                <div class="verification-card-header">
                                    <i class="fas fa-users" style="color: #017374; font-size: 20px;"></i>
                                    <span class="verification-card-title">Request verification from other departments</span>
                                </div>
                                <div id="departmentsSelectContainer" class="verification-card-content" style="display: block;">
                                    <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px; display: block;">Select department:</label>
                                    <select id="requestDepartmentsSelect" class="verification-select" onchange="addRequestDepartment()" disabled>
                                        <option value="">Select department</option>
                                        <!-- Will be populated by JavaScript -->
                                    </select>
                                    <div id="selectedDepartmentsChips" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notify Me Checkbox - Hidden by default for self verification -->
                    <div class="form-section" style="display: none;">
                        <label class="verify-checkbox-item-themed">
                            <input type="checkbox" id="notifyCheckbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: #017374;">
                            <span class="verify-checkbox-text-themed">
                                <i class="fas fa-bell" style="margin-right: 6px; color: #017374;"></i>
                                Notify me when the answer is verified
                            </span>
                        </label>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button class="btn-primary" onclick="submitQuestion()">
                            Submit
                        </button>
                    </div>

                </div>

                <!-- Right Sidebar -->
                <aside class="right-sidebar">
                    <div class="info-box">
                        <div class="box-title">Community Stats</div>
                        <div class="stat-row">
                            <span>Total Questions</span>
                            <span class="stat-value" id="totalQuestions">-</span>
                        </div>
                        <div class="stat-row">
                            <span>Verified Answers</span>
                            <span class="stat-value" id="verifiedCount">-</span>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="box-title">Hot Questions</div>
                        <div class="mini-list" id="sidebarHotQuestions">
                            <div class="sidebar-loading-text">Loading...</div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <style>
        /* CSS Variables for Theme Support */
        :root {
            /* Light theme (default) */
            --text-color: #333;
            --text-muted: #666;
            --text-primary: #333;
            --input-bg: #ffffff;
            --border-color: #ccc;
            --accent-color: #0a8276;
            --accent-hover: #086b61;
            --bg-secondary: #f5f5f5;
        }

        [data-theme="dark"] {
            --text-color: #e0e0e0;
            --text-muted: #999;
            --text-primary: #e0e0e0;
            --input-bg: #2d2d2d;
            --border-color: #444;
            --accent-color: #0a8276;
            --accent-hover: #086b61;
            --bg-secondary: #1e1e1e;
        }

        [data-theme="light"] {
            --text-color: #333;
            --text-muted: #666;
            --text-primary: #333;
            --input-bg: #ffffff;
            --border-color: #ccc;
            --accent-color: #0a8276;
            --accent-hover: #086b61;
            --bg-secondary: #f5f5f5;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .form-hint {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .form-input:focus {
            outline: none;
            border-color: #017374;
            box-shadow: 0 0 0 3px rgba(1, 115, 116, 0.1);
        }

        /* Tags Label & Input Styles */
        .form-label-tags {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .form-input-tags {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 13px;
            transition: all 0.2s;
        }

        .form-input-tags:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(10, 130, 118, 0.15);
        }

        .form-input-tags::placeholder {
            color: var(--text-muted);
        }

        .form-add-tag-btn {
            padding: 10px 16px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-add-tag-btn:hover {
            background: var(--accent-hover);
        }

        /* TinyMCE Dark Theme Overrides */
        [data-theme="dark"] .tox-tinymce {
            background-color: #2d2d2d !important;
            border-color: #444 !important;
        }

        [data-theme="dark"] .tox-toolbar {
            background-color: #2d2d2d !important;
            border-color: #444 !important;
        }

        [data-theme="dark"] .tox-editor-container {
            background-color: #2d2d2d !important;
        }

        [data-theme="dark"] .tox-tbtn {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .tox-tbtn:hover {
            background-color: #1a1a1a !important;
        }

        [data-theme="dark"] .tox-edit-area {
            background-color: #1e1e1e !important;
        }

        /* TinyMCE Light Theme Overrides */
        [data-theme="light"] .tox-tinymce {
            background-color: #ffffff !important;
            border-color: #ccc !important;
        }

        [data-theme="light"] .tox-toolbar {
            background-color: #f5f5f5 !important;
            border-color: #ddd !important;
        }

        /* Verification Cards Container */
        .verification-cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            .verification-cards-container {
                grid-template-columns: 1fr;
            }
        }

        /* Verification Card */
        .verification-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .verification-card:hover {
            border-color: #017374;
            box-shadow: 0 2px 8px rgba(1, 115, 116, 0.15);
        }

        .verification-card-active {
            border-color: #017374;
            background: rgba(1, 115, 116, 0.05);
        }

        [data-theme="light"] .verification-card {
            background: #ffffff;
            border-color: #e0e0e0;
        }

        [data-theme="light"] .verification-card:hover {
            border-color: #017374;
        }

        [data-theme="light"] .verification-card-active {
            background: #e8f5f5;
            border-color: #017374;
        }

        /* Card Header */
        .verification-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .verification-card-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        /* Card Content */
        .verification-card-content {
            margin-top: 12px;
        }

        /* Verification Select */
        .verification-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Multiple select styling */
        .verification-select[multiple] {
            min-height: 120px;
            padding: 4px;
        }
        
        .verification-select[multiple] option {
            padding: 6px 8px;
            border-radius: 2px;
            margin-bottom: 2px;
        }
        
        .verification-select[multiple] option:checked {
            background: linear-gradient(135deg, #017374 0%, #0a8276 100%);
            color: white;
        }

        .verification-select:focus {
            outline: none;
            border-color: #017374;
            box-shadow: 0 0 0 2px rgba(1, 115, 116, 0.1);
        }
        
        .verification-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-secondary);
        }

        [data-theme="light"] .verification-select {
            background: #ffffff;
            border-color: #ddd;
        }
        
        [data-theme="light"] .verification-select[multiple] option:checked {
            background: linear-gradient(135deg, #017374 0%, #0a8276 100%);
            color: white;
        }

        /* Department Chips */
        .department-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #017374 0%, #0a8276 100%);
            color: white;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .department-chip .remove-chip {
            cursor: pointer;
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .department-chip .remove-chip:hover {
            opacity: 1;
        }

        /* Placeholder Button */
        .verification-placeholder-btn {
            width: 100%;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .verification-placeholder-btn:hover {
            border-color: #017374;
            color: #017374;
            background: rgba(1, 115, 116, 0.05);
        }

        [data-theme="light"] .verification-placeholder-btn {
            border-color: #ccc;
        }

        /* Notify Checkbox Themed Styles */
        .verify-checkbox-item-themed {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(1, 115, 116, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(1, 115, 116, 0.2);
            transition: all 0.2s;
        }

        [data-theme="light"] .verify-checkbox-item-themed {
            background: rgba(1, 115, 116, 0.08);
            border-color: rgba(1, 115, 116, 0.3);
        }

        .verify-checkbox-text-themed {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
        }

        .sidebar-loading-text {
            color: var(--text-muted);
            padding: 10px;
            text-align: center;
        }

        /* Department Label Styles */
        .dept-label {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .dept-label:hover {
            background: var(--border-color);
        }

        .dept-label-text {
            font-size: 14px;
            color: var(--text-color);
        }



        #departmentsBox {
            border: 2px solid #017374;
            border-radius: 4px;
            padding: 15px;
            background: var(--input-bg);
            color: var(--text-color);
            min-height: 100px;
            max-height: 250px;
            overflow-y: auto;
        }

        #departmentsBox label {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        #departmentsBox label:hover {
            background: rgba(1, 115, 116, 0.1);
        }

        [data-theme="dark"] #departmentsBox label:hover {
            background: rgba(1, 115, 116, 0.2);
        }

        #departmentsBox input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            margin-right: 10px;
            accent-color: #017374;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 0 0 4px 4px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            resize: vertical;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .editor-toolbar {
            display: flex;
            gap: 2px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 14px;
        }

        .editor-btn:hover {
            background: var(--border-color);
            color: var(--text-color);
        }

        .tags-input-container {
            position: relative;
        }

        /* File Upload Styles */
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .file-drop-zone:hover {
            border-color: #017374;
            background: rgba(1, 115, 116, 0.05);
        }

        [data-theme="dark"] .file-drop-zone:hover {
            border-color: #017374;
            background: #0d2525;
        }

        .file-drop-zone.drag-over {
            border-color: #017374;
            background: rgba(1, 115, 116, 0.1);
            box-shadow: 0 0 10px rgba(1, 115, 116, 0.2);
        }

        [data-theme="dark"] .file-drop-zone.drag-over {
            background: #0d3d3d;
        }

        /* Small File Upload Button */
        .file-upload-btn-small {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 2px dashed #4caf50;
            border-radius: 4px;
            color: #66bb6a;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .file-upload-btn-small:hover {
            background: rgba(76, 175, 80, 0.1);
            border-color: #66bb6a;
            color: #81c784;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.2);
        }

        .file-upload-btn-small i {
            font-size: 13px;
        }

        [data-theme="light"] .file-upload-btn-small {
            background: white;
            border-color: #4caf50;
            color: #4caf50;
        }

        [data-theme="light"] .file-upload-btn-small:hover {
            background: rgba(76, 175, 80, 0.05);
            border-color: #45a049;
            color: #45a049;
        }

        /* Files List Styling */
        #filesList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: rgba(23, 162, 184, 0.05);
            border-radius: 4px;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        [data-theme="light"] #filesList {
            background: rgba(23, 162, 184, 0.05);
            border-color: rgba(23, 162, 184, 0.2);
        }

        .file-drop-content {
            pointer-events: none;
        }

        .files-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--input-bg);
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #017374;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-item-icon {
            font-size: 20px;
            color: #017374;
            width: 30px;
            text-align: center;
        }

        .file-item-details {
            flex: 1;
        }

        .file-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .file-item-size {
            font-size: 12px;
            color: #999;
        }

        .file-item-remove {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .file-item-remove:hover {
            background: #ff3838;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-primary {
            padding: 12px 24px;
            background: #0a95ff;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #0074cc;
        }

        .btn-secondary {
            padding: 12px 24px;
            background: #3d3d3d;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #2d2d2d;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Notify Checkbox Styles */
        .verify-checkbox-item:hover {
            background: rgba(1, 115, 116, 0.1) !important;
            border-color: rgba(1, 115, 116, 0.4) !important;
        }

        [data-theme="dark"] .verify-checkbox-item {
            background: rgba(1, 115, 116, 0.1) !important;
            border-color: rgba(1, 115, 116, 0.3) !important;
        }

        [data-theme="dark"] .verify-checkbox-item:hover {
            background: rgba(1, 115, 116, 0.15) !important;
            border-color: rgba(1, 115, 116, 0.5) !important;
        }

        [data-theme="dark"] .verify-checkbox-text {
            color: #e0e0e0 !important;
        }

        .dept-checkbox-label {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dept-checkbox-label:hover {
            background: var(--bg-secondary);
        }

        .dept-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        #departmentsSection {
            display: block;
            padding: 0;
            background: transparent;
            border: none;
            margin-bottom: 0;
        }

        #departmentsSection.hidden {
            display: none;
        }

        #departmentsCheckboxGroup {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        #departmentsCheckboxGroup label {
            padding: 12px !important;
            border-bottom: 1px solid var(--border-color);
            margin: 0;
            transition: background 0.2s;
        }

        #departmentsCheckboxGroup label:last-child {
            border-bottom: none;
        }

        #departmentsCheckboxGroup label:hover {
            background: var(--bg-secondary);
        }

        #departmentsCheckboxGroup input[type="checkbox"] {
            accent-color: #0a95ff;
        }

        /* Preview Pane Styles */
        #previewPane {
            border: 1px solid var(--border-color) !important;
            border-radius: 4px !important;
            padding: 15px !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            background: var(--bg-secondary) !important;
            color: var(--text-color);
        }

        #previewContent {
            font-size: 14px;
            line-height: 1.6;
        }

        #previewContent h1,
        #previewContent h2,
        #previewContent h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #previewContent h1 { font-size: 28px; }
        #previewContent h2 { font-size: 24px; }
        #previewContent h3 { font-size: 20px; }

        #previewContent strong {
            font-weight: 600;
            color: inherit;
        }

        #previewContent em {
            font-style: italic;
        }

        #previewContent code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        #previewContent pre {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }

        #previewContent ul,
        #previewContent ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        #previewContent li {
            margin: 5px 0;
        }

        #previewContent blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 12px;
            margin: 10px 0;
            color: var(--text-muted);
            font-style: italic;
        }

        #previewContent table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        #previewContent table th,
        #previewContent table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        #previewContent table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        #previewContent img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 4px;
        }

        #previewContent a {
            color: #0a95ff;
            text-decoration: none;
        }

        #previewContent a:hover {
            text-decoration: underline;
        }

        /* Departments Dropdown Styles */
        #departmentsDropdown {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-color);
            cursor: pointer;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-top: 8px;
            min-height: 120px;
        }

        #departmentsDropdown:hover {
            border-color: #0a95ff;
            box-shadow: 0 0 0 2px rgba(10, 149, 255, 0.1);
        }

        #departmentsDropdown:focus {
            outline: none;
            border-color: #0a95ff;
            box-shadow: 0 0 0 3px rgba(10, 149, 255, 0.2);
        }

        #departmentsDropdown option {
            padding: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
        }

        #departmentsDropdown option:checked {
            background: #0a95ff;
            color: white;
            font-weight: 600;
        }

        #departmentsSection {
            display: block;
            padding: 0;
            background: transparent;
            border: none;
            margin-bottom: 0;
        }

        #departmentsSection.hidden {
            display: none;
        }
    </style>

    <script>
        let currentUserId = null;
        const AVAILABLE_DEPARTMENTS = ['WT', 'FT', 'P', 'LOG', 'OE', 'IT', 'Other'];
        let selectedFiles = []; // Store selected files for submission
        
        // Tags array - MUST be declared at top level so all functions can access it
        let customTags = [];
        let selectedRequestDepartments = []; // Array to store selected departments for request verification

        // Add department to request verification list
        function addRequestDepartment() {
            const select = document.getElementById('requestDepartmentsSelect');
            const selectedValue = select.value;
            
            if (!selectedValue) return;
            
            // Check if already selected
            if (selectedRequestDepartments.includes(selectedValue)) {
                alert('This department is already selected');
                select.value = '';
                return;
            }
            
            // Add to array
            selectedRequestDepartments.push(selectedValue);
            
            // Reset dropdown
            select.value = '';
            
            // Update chips display
            renderRequestDepartmentChips();
        }

        // Remove department from request verification list
        function removeRequestDepartment(dept) {
            selectedRequestDepartments = selectedRequestDepartments.filter(d => d !== dept);
            renderRequestDepartmentChips();
        }

        // Render department chips
        function renderRequestDepartmentChips() {
            const container = document.getElementById('selectedDepartmentsChips');
            if (!container) return;
            
            if (selectedRequestDepartments.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedRequestDepartments.map(dept => `
                <span class="department-chip">
                    ${dept}
                    <span class="remove-chip" onclick="removeRequestDepartment('${dept}')" title="Remove">Ã—</span>
                </span>
            `).join('');
        }
        
        // Initialize markdown-it
        const md = window.markdownit({
            html: true,
            breaks: true,
            linkify: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(str, { language: lang }).value;
                    } catch (__) {}
                }
                return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await getCurrentUser();
            setupSidebarToggle();
            initTheme();
            setupVerificationType();
            initializeDepartmentsDropdown();
            initializeTinyMCE();
            setupFileUpload();
            loadCommunityStats();
            await loadHotTags(); // Load hot tags from API
        });

        // Load Hot Tags from API
        async function loadHotTags() {
            try {
                const res = await fetch('/api/hot-tags?limit=8');
                const data = await res.json();
                if (data.success && data.tags.length > 0) {
                    const tagsListDiv = document.getElementById('tagsList');
                    tagsListDiv.innerHTML = data.tags.map(t => 
                        `<span class="sidebar-tag-item" data-tag="${t.tag}" onclick="addTagFromSidebar('${t.tag}')" style="cursor: pointer;">${t.tag}</span>`
                    ).join('');
                }
            } catch (e) {
                console.error('Error loading hot tags:', e);
            }
        }

        // Add tag from sidebar click
        function addTagFromSidebar(tagName) {
            if (!tagName) return;
            
            if (customTags.length >= 5) {
                alert('Maximum 5 tags allowed');
                return;
            }
            
            if (customTags.includes(tagName)) {
                alert('This tag already added');
                return;
            }
            
            customTags.push(tagName);
            renderCustomTags();
        }

        // Load Community Stats and Hot Questions
        async function loadCommunityStats() {
            try {
                const res = await fetch('/api/get-all-verified-answers');
                const data = await res.json();
                const allQuestions = (data.results || data.answers || []).map((q, idx) => ({
                    ...q,
                    id: q.id || idx,
                    views: q.views || 0,
                    score: q.score || 0
                }));

                // Update stats
                document.getElementById('totalQuestions').textContent = allQuestions.length;

                // Count verified questions using same logic as community.html
                const verifiedCount = allQuestions.filter(q => {
                    if (q.verification_type === 'self') {
                        return true; // Self-verified is always considered verified
                    } else if (q.verification_type === 'request') {
                        // For request type: all requested departments must have verified
                        const verificationCount = q.verification_count || 0;
                        const totalRequestedDepts = q.total_requested_depts || 0;
                        return totalRequestedDepts > 0 && verificationCount === totalRequestedDepts;
                    }
                    return false;
                }).length;

                document.getElementById('verifiedCount').textContent = verifiedCount;

                // Update Hot Questions
                updateHotQuestions(allQuestions);
            } catch (e) {
                console.error('Error loading community stats:', e);
                document.getElementById('totalQuestions').textContent = '0';
                document.getElementById('verifiedCount').textContent = '0';
            }
        }

        function updateHotQuestions(allQuestions) {
            if (allQuestions.length === 0) {
                const hotQuestionsDiv = document.getElementById('sidebarHotQuestions');
                if (hotQuestionsDiv) {
                    hotQuestionsDiv.innerHTML = '<div style="color: #999; padding: 10px; text-align: center; font-size: 13px;">No questions yet</div>';
                }
                return;
            }

            // Sort by vote_score (descending) and get top 3
            const topQuestions = [...allQuestions]
                .sort((a, b) => {
                    const scoreA = a.vote_score || a.score || 0;
                    const scoreB = b.vote_score || b.score || 0;
                    return scoreB - scoreA;
                })
                .slice(0, 3);

            // Update Hot Questions list with consistent styling
            const hotQuestionsDiv = document.getElementById('sidebarHotQuestions');
            if (hotQuestionsDiv) {
                if (topQuestions.length === 0) {
                    hotQuestionsDiv.innerHTML = '<div style="color: #999; padding: 10px; text-align: center; font-size: 13px;">No questions yet</div>';
                } else {
                    hotQuestionsDiv.innerHTML = topQuestions.map((q, idx) => {
                        const scoreDisplay = q.score || 0;
                        const title = escapeHtml(q.question || q.question_title || 'Untitled');
                        return `<a href="comment.html?id=${q.id}" class="mini-link" onclick="event.stopPropagation()" style="display: flex; align-items: center; gap: 8px;" title="Score: ${scoreDisplay}"><span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${title}</span></a>`;
                    }).join('');
                }
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        async function getCurrentUser() {
            try {
                const res = await fetch('/auth/session');
                if (!res.ok) throw new Error('Failed to get session');
                const data = await res.json();
                
                const loginBtn = document.getElementById('loginBtn');
                const usernameDisplay = document.getElementById('usernameDisplay');
                
                if (data.loggedIn) {
                    currentUserId = data.userId || null;
                    
                    if (loginBtn) {
                        loginBtn.textContent = data.isGuest ? 'Login' : 'Logout';
                        loginBtn.href = data.isGuest ? '/auth/login' : '/auth/logout';
                    }
                    
                    if (!data.isGuest && data.username && usernameDisplay) {
                        usernameDisplay.textContent = `Welcome: ${data.username}`;
                        usernameDisplay.style.display = 'inline';
                    }
                } else {
                    // Not logged in, redirect to login
                    window.location.href = '/auth/login';
                }
            } catch (e) {
                console.log('User not logged in:', e);
                window.location.href = '/auth/login';
            }
        }

        function setupSidebarToggle() {
            const toggleBtn = document.getElementById('toggleSidebarButton');
            const chatList = document.getElementById('chatList');
            const chatbox = document.getElementById('chatbox');
            const header = document.querySelector('.header1');

            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                chatList.classList.add('collapsed');
                chatbox.classList.add('collapsed');
                header.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
            }

            toggleBtn.addEventListener('click', () => {
                chatList.classList.toggle('collapsed');
                chatbox.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
                toggleBtn.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', chatList.classList.contains('collapsed'));
            });
        }

        // Setup verification type selection
        function setupVerificationType() {
            const radios = document.querySelectorAll('input[name="verificationType"]');
            const notifySection = document.getElementById('notifyCheckbox')?.closest('.form-section');

            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'request') {
                        // Show notify checkbox for request verification
                        if (notifySection) {
                            notifySection.style.display = 'block';
                        }
                    } else {
                        // Clear selected request departments when switching to self
                        selectedRequestDepartments = [];
                        renderRequestDepartmentChips();
                        // Hide notify checkbox for self verification
                        if (notifySection) {
                            notifySection.style.display = 'none';
                        }
                    }
                });
            });
            
            // Initialize: hide notify checkbox by default (self is selected)
            if (notifySection) {
                notifySection.style.display = 'none';
            }
        }

        // Handle card selection
        function selectVerificationCard(type) {
            const selfCard = document.getElementById('selfCard');
            const requestCard = document.getElementById('requestCard');
            const selfRadio = document.querySelector('input[name="verificationType"][value="self"]');
            const requestRadio = document.querySelector('input[name="verificationType"][value="request"]');
            const selfSelect = document.getElementById('selfDepartmentSelect');
            const requestSelect = document.getElementById('requestDepartmentsSelect');
            
            // Get notify section
            const notifyCheckbox = document.getElementById('notifyCheckbox');
            const notifySection = notifyCheckbox?.closest('.form-section');

            if (type === 'self') {
                // Highlight self card, unhighlight request card
                selfCard.classList.add('verification-card-active');
                requestCard.classList.remove('verification-card-active');
                selfRadio.checked = true;
                requestRadio.checked = false;
                // Enable self dropdown, disable request dropdown
                selfSelect.disabled = false;
                requestSelect.disabled = true;
                // Hide notify section for self verification
                if (notifySection) notifySection.style.display = 'none';
            } else {
                // Highlight request card, unhighlight self card
                requestCard.classList.add('verification-card-active');
                selfCard.classList.remove('verification-card-active');
                requestRadio.checked = true;
                selfRadio.checked = false;
                // Disable self dropdown, enable request dropdown
                selfSelect.disabled = true;
                requestSelect.disabled = false;
                // Show notify section for request verification
                if (notifySection) notifySection.style.display = 'block';
            }
        }

        // Placeholder function for request verification modal
        function showRequestVerificationModal() {
            alert('Request verification modal coming soon!\\n\\nThis will allow you to:\\n- Select multiple departments\\n- Set a due date\\n- Add verification notes');
        }

        // Setup file upload functionality
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            
            // Handle file selection from input
            fileInput.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files), MAX_FILE_SIZE);
            });
        }

        // Handle file selection
        function handleFiles(files, maxSize) {
            const validFiles = [];
            
            for (const file of files) {
                // Check file size
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large (max 10MB)`);
                    continue;
                }
                
                // Check file type (basic validation)
                const validTypes = [
                    'image/jpeg', 'image/png', 'image/gif', 'image/webp',
                    'application/pdf',
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'text/plain'
                ];
                
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" has unsupported type. Supported: Images, PDF, Word, Excel, Text`);
                    continue;
                }
                
                validFiles.push(file);
            }
            
            // Add valid files to our array
            if (validFiles.length > 0) {
                selectedFiles.push(...validFiles);
                renderFilesList();
            }
        }

        // Render files list UI
        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const fileInput = document.getElementById('fileInput');
            
            if (selectedFiles.length === 0) {
                filesList.style.display = 'none';
                fileInput.value = ''; // Clear input
                return;
            }
            
            filesList.style.display = 'block';
            filesList.innerHTML = selectedFiles.map((file, index) => {
                const fileType = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);
                return `
                    <div class="file-item">
                        <div class="file-item-info">
                            <div class="file-item-icon">${fileType}</div>
                            <div class="file-item-details">
                                <div class="file-item-name">${file.name}</div>
                                <div class="file-item-size">${fileSize}</div>
                            </div>
                        </div>
                        <button type="button" class="file-item-remove" onclick="removeFile(${index})">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Remove a file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilesList();
        }

        // Get appropriate icon for file type
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'ðŸ–¼ï¸';
            if (mimeType === 'application/pdf') return 'ðŸ“„';
            if (mimeType.includes('word')) return 'ðŸ“';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'ðŸ“Š';
            if (mimeType === 'text/plain') return 'ðŸ“ƒ';
            return 'ðŸ“Ž';
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize departments checkbox group
        function initializeDepartmentsDropdown() {
            const selfDepartmentSelect = document.getElementById('selfDepartmentSelect');
            const requestDepartmentsSelect = document.getElementById('requestDepartmentsSelect');
            
            // Populate self department select dropdown
            if (selfDepartmentSelect) {
                AVAILABLE_DEPARTMENTS.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    selfDepartmentSelect.appendChild(option);
                });
            }
            
            // Populate request departments select dropdown (multiple)
            if (requestDepartmentsSelect) {
                AVAILABLE_DEPARTMENTS.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    requestDepartmentsSelect.appendChild(option);
                });
            }
        }

        // Main submit function (customTags is now declared at top of script)
        async function submitQuestion() {
            const title = document.getElementById('questionTitle').value.trim();
            const body = tinymce.get('questionBody') ? tinymce.get('questionBody').getContent() : document.getElementById('questionBody').value;
            const verificationType = document.querySelector('input[name="verificationType"]:checked').value;
            const notifyMe = document.getElementById('notifyCheckbox').checked; // Get notify_me value

            console.log('ðŸ·ï¸ customTags before submit:', customTags);
            console.log('ðŸ·ï¸ customTags length:', customTags.length);

            if (!title) {
                alert('Please enter a title');
                return;
            }

            if (!body) {
                alert('Please enter a body');
                return;
            }
            const tagArray = customTags.length > 0 ? customTags : [];

            try {
                // Get session data
                const sessionResponse = await fetch('/auth/session');
                if (!sessionResponse.ok) {
                    alert('Error: Unable to get session data');
                    return;
                }
                const sessionData = await sessionResponse.json();
                const userName = sessionData?.username || 'Anonymous';

                let payload = {
                    question: title,
                    answer: body,
                    tags: tagArray,
                    verificationType: verificationType,
                    userName: userName,
                    rating: 1,
                    comment: '',
                    notify_me: notifyMe  // Add notify_me to payload
                };

                // Get departments based on verification type
                let selectedDepts = [];
                if (verificationType === 'request') {
                    // Get selected departments from the array
                    selectedDepts = [...selectedRequestDepartments];
                    
                    if (selectedDepts.length === 0) {
                        alert('Please select at least one department for verification request');
                        return;
                    }
                } else if (verificationType === 'self') {
                    const selfDeptSelect = document.getElementById('selfDepartmentSelect');
                    const selectedDept = selfDeptSelect?.value;

                    if (!selectedDept) {
                        alert('Please select your department');
                        return;
                    }
                    selectedDepts = [selectedDept];
                }

                // Add selected departments to payload
                if (selectedDepts.length > 0) {
                    payload.requestedDepartments = selectedDepts;
                }

                // If there are files, use FormData instead of JSON
                if (selectedFiles.length > 0) {
                    const formData = new FormData();
                    formData.append('question', payload.question);
                    formData.append('answer', payload.answer);
                    formData.append('tags', JSON.stringify(payload.tags));
                    formData.append('verificationType', payload.verificationType);
                    formData.append('userName', payload.userName);
                    formData.append('rating', payload.rating);
                    formData.append('comment', payload.comment);
                    formData.append('notify_me', payload.notify_me);  // Add notify_me to FormData
                    if (payload.requestedDepartments) {
                        formData.append('requestedDepartments', JSON.stringify(payload.requestedDepartments));
                    }

                    // Add files
                    selectedFiles.forEach((file, index) => {
                        formData.append(`files`, file);
                    });

                    const response = await fetch('/api/verify-answer', {
                        method: 'POST',
                        body: formData
                        // Do NOT set Content-Type header when using FormData - browser will set it with boundary
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        alert('Error: ' + (error.error || `Server error (${response.status})`));
                        return;
                    }

                    const data = await response.json();
                    if (data.success) {
                        alert('âœ“ Question submitted successfully with attachments!');
                        window.location.href = '/community.html';
                    } else {
                        alert('Error: ' + (data.error || 'Failed to submit question'));
                    }
                } else {
                    // No files - use JSON
                    const response = await fetch('/api/verify-answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        alert('Error: ' + (error.error || `Server error (${response.status})`));
                        return;
                    }

                    const data = await response.json();
                    if (data.success) {
                        alert('âœ“ Question submitted successfully!');
                        window.location.href = '/community.html';
                    } else {
                        alert('Error: ' + (data.error || 'Failed to submit question'));
                    }
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to submit question: ' + e.message);
            }
        }

        // Tags functionality (customTags is declared at top of script block)
        function addCustomTag() {
            const input = document.getElementById('questionTags');
            const tagName = input.value.trim();
            
            console.log('ðŸ·ï¸ addCustomTag called, tagName:', tagName);
            
            if (!tagName) {
                return;
            }
            
            if (customTags.length >= 5) {
                alert('Maximum 5 tags allowed');
                return;
            }
            
            if (customTags.includes(tagName)) {
                alert('This tag already exists');
                return;
            }
            
            customTags.push(tagName);
            console.log('ðŸ·ï¸ Tag added, customTags now:', customTags);
            renderCustomTags();
            input.value = '';
        }

        function removeCustomTag(tagName) {
            customTags = customTags.filter(t => t !== tagName);
            renderCustomTags();
        }

        function renderCustomTags() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = customTags.map(tag => `
                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #0a8276; color: white; border-radius: 6px; font-size: 13px; font-weight: 500;">
                    <span>${tag}</span>
                    <button onclick="removeCustomTag('${tag}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                        Ã—
                    </button>
                </span>
            `).join('');
        }

        // Add tag button click event - use DOMContentLoaded to ensure elements exist
        document.addEventListener('DOMContentLoaded', function() {
            const addTagBtn = document.getElementById('addTagBtn');
            const questionTagsInput = document.getElementById('questionTags');
            
            console.log('ðŸ·ï¸ Setting up tag listeners...');
            console.log('ðŸ·ï¸ addTagBtn found:', !!addTagBtn);
            console.log('ðŸ·ï¸ questionTagsInput found:', !!questionTagsInput);
            
            if (addTagBtn) {
                addTagBtn.addEventListener('click', function() {
                    console.log('ðŸ·ï¸ Add button clicked!');
                    addCustomTag();
                });
            }
            
            if (questionTagsInput) {
                questionTagsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('ðŸ·ï¸ Enter pressed!');
                        e.preventDefault();
                        addCustomTag();
                    }
                });
            }
        });

        // Initialize TinyMCE editor (WYSIWYG - What You See Is What You Get)
        function initializeTinyMCE() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const contentStyle = currentTheme === 'dark' 
                ? 'body { background-color: #2d2d2d !important; color: #e0e0e0 !important; } p { color: #e0e0e0 !important; }'
                : 'body { background-color: #ffffff !important; color: #333 !important; } p { color: #333 !important; }';
            
            tinymce.init({
                selector: '#questionBody',
                plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste help wordcount',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                menubar: 'file edit view insert format table tools help',
                height: 400,
                branding: false,
                promotion: false,
                skin: currentTheme === 'dark' ? 'oxide-dark' : 'oxide',
                content_css: currentTheme === 'dark' ? 'dark' : 'default',
                content_style: contentStyle,
                init_instance_callback: function(editor) {
                    console.log('TinyMCE initialized');
                }
            });
        }

        // Reinitialize TinyMCE when theme changes
        function reinitializeTinyMCE() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const contentStyle = currentTheme === 'dark' 
                ? 'body { background-color: #2d2d2d !important; color: #e0e0e0 !important; } p { color: #e0e0e0 !important; }'
                : 'body { background-color: #ffffff !important; color: #333 !important; } p { color: #333 !important; }';

            tinymce.remove();
            setTimeout(() => {
                tinymce.init({
                    selector: '#questionBody',
                    plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste help wordcount',
                    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                    menubar: 'file edit view insert format table tools help',
                    height: 400,
                    branding: false,
                    promotion: false,
                    skin: currentTheme === 'dark' ? 'oxide-dark' : 'oxide',
                    content_css: currentTheme === 'dark' ? 'dark' : 'default',
                    content_style: contentStyle,
                    init_instance_callback: function(editor) {
                        console.log('TinyMCE reinitialized with new theme');
                    }
                });
            }, 100);
        }
        let currentTheme = localStorage.getItem('theme') || 'dark';

        function initTheme() {
            currentTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            updateThemeLabel();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeLabel();
            reinitializeTinyMCE(); // Update TinyMCE theme
        }

        function updateThemeLabel() {
            const label = document.getElementById('themeLabel');
            const icon = document.querySelector('#themeToggleBtn i');
            if (currentTheme === 'dark') {
                label.textContent = 'Dark';
                icon.className = 'fas fa-moon';
            } else {
                label.textContent = 'Light';
                icon.className = 'fas fa-sun';
            }
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'theme') {
                currentTheme = e.newValue || 'dark';
                document.body.setAttribute('data-theme', currentTheme);
                updateThemeLabel();
            }
        });

        document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
    </script>
</body>
</html>
