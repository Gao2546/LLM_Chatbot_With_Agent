<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Q&A Detail - Comments</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712108.png">
    <link rel="stylesheet" href="community.css?v=5.0">
    <link rel="stylesheet" href="comment.css?v=2.1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script>
        // Apply theme immediately before page renders
        const theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
    </script>
    <style>
        /* CSS Variables for AI Sources */
        :root {
            --sources-bg: #fff;
            --sources-border: #e0e0e0;
            --sources-text: #333;
            --source-item-bg: #f8f9fa;
        }
        
        body[data-theme="dark"],
        [data-theme="dark"] {
            --sources-bg: #2a2a2a;
            --sources-border: #404040;
            --sources-text: #e0e0e0;
            --source-item-bg: #333;
        }
        
        /* Dark theme fix for AI Sources - inline to ensure priority */
        body[data-theme="dark"] .ai-sources-toggle,
        [data-theme="dark"] .ai-sources-toggle {
            background: #2a2a2a !important;
            border-color: #404040 !important;
            color: #e0e0e0 !important;
        }
        body[data-theme="dark"] .ai-sources-details,
        [data-theme="dark"] .ai-sources-details {
            background: #2a2a2a !important;
            border-color: #404040 !important;
        }
        body[data-theme="dark"] .ai-sources-title,
        [data-theme="dark"] .ai-sources-title {
            color: #e0e0e0 !important;
        }
        body[data-theme="dark"] .ai-source-item,
        [data-theme="dark"] .ai-source-item {
            background: #333 !important;
        }
        body[data-theme="dark"] .ai-source-label,
        [data-theme="dark"] .ai-source-label {
            color: #e0e0e0 !important;
        }
        body[data-theme="dark"] .ai-source-question,
        [data-theme="dark"] .ai-source-question {
            color: #e0e0e0 !important;
        }
        body[data-theme="dark"] .source-question-link,
        [data-theme="dark"] .source-question-link {
            color: #64b5f6 !important;
        }
        body[data-theme="dark"] .ai-source-verified-by,
        [data-theme="dark"] .ai-source-verified-by {
            color: #999 !important;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Inline script to apply theme to body immediately -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        })();
    </script>
    <!-- Auth Container (Top Right) -->
    <div class="auth-container">
        <span id="usernameDisplay" style="display: none; margin-right: 10px;"></span>
        
        <!-- Notification Bell -->
        <div class="notification-bell-container">
            <button id="notificationBellBtn" class="notification-bell" title="Notifications">
                <i class="fas fa-bell"></i>
                <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
            </button>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" class="notification-dropdown" style="display: none;">
                <div class="notification-header">
                    <h3>Notifications</h3>
                    <button id="closeNotificationBtn" class="close-notification-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="notificationList" class="notification-list">
                    <!-- Notifications will be loaded here -->
                    <div class="empty-notifications">No notifications</div>
                </div>
            </div>
        </div>
        
        <a href="auth/login" class="login-button" id="loginBtn">Login</a>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div id="chatList">
            <div class="btn-sidebar-container"></div>
            
            <!-- Infineon Logo -->
            <div class="sidebar-logo">
                <img src="image.png" alt="Infineon Logo" class="infineon-logo">
            </div>
            
            <!-- Q&A Community Button -->
            <a href="community.html" class="community-nav-button">
                <i class="fas fa-comments"></i> Q&A Community
            </a>

            <!-- AI Chat Button -->
            <a href="/" class="community-nav-button">
                <i class="fas fa-robot"></i> AI Chat
            </a>

            <!-- Filter By Section -->
            <div class="sidebar-section">
                <div class="section-title">Filter By</div>
                <a href="community.html" class="sidebar-link">All questions</a>
                <a href="#" class="sidebar-link">My Questions</a>
                <a href="#" class="sidebar-link">My Answers</a>
                <a href="#" class="sidebar-link">Pending review</a>
                <a href="#" class="sidebar-link">Unverified</a>
            </div>

            <!-- Theme Toggle Button -->
            <div class="theme-toggle-container">
                <button id="themeToggleBtn" class="theme-toggle-btn" title="Change Theme">
                    <i class="fas fa-palette"></i>
                    <span id="themeLabel">Dark</span>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="chatbox">
            <!-- Header -->
            <h1 class="header1">
                <button id="toggleSidebarButton"><i class="fas fa-bars"></i></button>
                Q&A Detail
            </h1>

            <!-- Content -->
            <div class="contain-overflow">
                <div class="content-wrapper qa-detail-wrapper">
                    <!-- Back Button -->
                    <div class="page-header">
                        <button class="back-button" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> Back to Community
                        </button>
                    </div>

                    <!-- Main Content Container with 3-Column Layout -->
                    <div class="qa-detail-container">
                        <!-- Left Column: Question & Comments -->
                        <div class="qa-left-column">
                            <!-- Question Detail -->
                            <div id="questionDetail" class="question-item">
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p>Loading question...</p>
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <div class="comments-section">
                                <div class="comments-header">
                                    <i class="fas fa-comments"></i> Comments (<span id="commentCount">0</span>)
                                </div>

                                <!-- Comment Form -->
                                <div class="comments-form">
                                    <div class="comment-input-group">
                                        <!-- Department Selection -->
                                        <div class="comment-dept-select">
                                            <label for="commentDept">Department:</label>
                                            <select id="commentDept" class="dept-select">
                                                <option value="">Select Department</option>
                                                <option value="WT">WT</option>
                                                <option value="FT">FT</option>
                                                <option value="P">P</option>
                                                <option value="LOG">LOG</option>
                                                <option value="OE">OE</option>
                                                <option value="IT">IT</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>

                                        <textarea 
                                            class="comment-textarea" 
                                            id="commentInput" 
                                            placeholder="Write your comment here..."
                                            rows="4"></textarea>

                                        <!-- File Upload -->
                                        <div class="comment-file-upload">
                                            <input type="file" id="commentAttachment" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;" />
                                            <label for="commentAttachment" class="file-upload-btn">
                                                <i class="fas fa-paperclip"></i> Attach Files (Images/PDF/Docs)
                                            </label>
                                            <div id="attachmentPreview" class="attachment-preview"></div>
                                        </div>

                                        <div class="comment-action-buttons">
                                            <button class="comment-submit" id="submitCommentBtn">
                                                <i class="fas fa-paper-plane"></i> Submit Comment
                                            </button>
                                            <button class="comment-verify" id="verifyCommentBtn" style="display: none;">
                                                <i class="fas fa-check-circle"></i> Verify
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Messages Container -->
                                <div id="messagesContainer"></div>

                                <!-- Comments List -->
                                <div class="comments-list" id="commentsList">
                                    <div class="empty-comments">
                                        <div class="empty-comments-icon">ðŸ’¬</div>
                                        <p>No comments yet. Be the first to comment!</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: AI Answer & Verification -->
                        <div class="qa-right-column">
                            <!-- AI Answer Section -->
                            <div class="ai-answer-section">
                                <div class="ai-answer-header">
                                    <i class="fas fa-robot"></i> AI Suggests
                                </div>
                                <div id="aiAnswerContent" class="ai-answer-content">
                                    <div class="loading-state">
                                        <div class="spinner"></div>
                                        <p>Loading AI answer...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Verification Status Section -->
                            <div class="verification-status-section">
                                <div class="verification-header">
                                    <i class="fas fa-check-double"></i> Verification
                                </div>
                                <div id="verificationStatusContent" class="verification-status-content">
                                    <div class="loading-state">
                                        <div class="spinner"></div>
                                        <p>Loading verification status...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Related Questions Section -->
                            <div class="related-questions-section-right">
                                <div class="related-questions-header">
                                    <i class="fas fa-link"></i> Related Questions
                                </div>
                                <div id="relatedQuestionsWrapper" class="related-questions-wrapper">
                                    <div id="relatedQuestionsSection" class="related-questions-section">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>Loading related questions...</p>
                                        </div>
                                    </div>
                                    <div id="relatedQuestionsLoadMore"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestionId = null;
        let comments = [];
        let verifications = [];
        let currentUserId = null;
        let currentUsername = null;
        let userRating = null;

        // Add CSS for preview modal
        const style = document.createElement('style');
        style.textContent = `
            .image-preview-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            }
            .image-preview-content {
                position: relative;
                max-width: 95vw;
                max-height: 95vh;
            }
            .modal-close-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: #fff;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-size: 28px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #333;
                z-index: 10001;
            }
            .modal-close-btn:hover {
                background: #f0f0f0;
            }
            .attachment-preview-btn {
                background: #0066cc;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                transition: background 0.2s;
            }
            .attachment-preview-btn:hover {
                background: #0052a3;
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ”„ DOMContentLoaded - Starting...');
            await getCurrentUser();
            console.log('ðŸ‘¤ getCurrentUser completed');
            await loadQuestionDetail();
            console.log('â“ loadQuestionDetail completed');
            await loadRelatedQuestions();
            console.log('ðŸ”— loadRelatedQuestions completed');
            setupSidebarToggle();
            console.log('âš™ï¸ setupSidebarToggle completed');
            setupCommentSubmit();
            console.log('ðŸ’¬ setupCommentSubmit completed');
            setupRatingButtons();
            console.log('â­ setupRatingButtons completed');
            setupVerificationDepartments();
            console.log('ðŸ¢ setupVerificationDepartments completed');
            setupFilterLinks();
            console.log('ðŸ”— setupFilterLinks completed');
            setupTheme();
            console.log('ðŸŽ¨ setupTheme completed');
            setupNotificationBell();
            console.log('ðŸ”” setupNotificationBell completed');
            await loadNotifications(); // Load notifications immediately on page load
            console.log('ðŸ”” loadNotifications completed');
            console.log('âœ… All setup functions completed');
        });

        async function loadHotTags() {
            try {
                const res = await fetch('/api/hot-tags?limit=8');
                const data = await res.json();
                if (data.success && data.tags.length > 0) {
                    const tagsListDiv = document.getElementById('tagsList');
                    tagsListDiv.innerHTML = data.tags.map(t => 
                        `<span class="sidebar-tag-item" data-tag="${t.tag}">${t.tag}</span>`
                    ).join('');
                    
                    // Re-attach click handlers
                    setupFilterLinks();
                }
            } catch (e) {
                console.error('Error loading hot tags:', e);
            }
        }

        // Load related questions using vector similarity
        const INITIAL_DISPLAY_COUNT = 2; // Show only 2 questions initially
        let allRelatedQuestionsData = []; // Store all fetched questions
        let relatedQuestionsExpanded = false;

        async function loadRelatedQuestions() {
            try {
                if (!currentQuestionId) return;

                const container = document.getElementById('relatedQuestionsSection');
                const sectionWrapper = container?.parentElement; // Get the parent section div
                if (!container) return;

                // Fetch ALL related questions from API
                const response = await fetch(`/api/related-questions-all/${currentQuestionId}`);
                const data = await response.json();

                if (!data.success) {
                    console.warn('Failed to load related questions:', data.error);
                    // Hide the entire section if error
                    if (sectionWrapper) {
                        sectionWrapper.style.display = 'none';
                    }
                    return;
                }

                allRelatedQuestionsData = data.results || [];
                const totalRelated = allRelatedQuestionsData.length;

                if (totalRelated === 0) {
                    // Hide the entire section if no related questions
                    if (sectionWrapper) {
                        sectionWrapper.style.display = 'none';
                    }
                    return;
                }

                // Render initial questions (show only 2)
                renderRelatedQuestionsToggle(false);
                
                // Set grid layout based on result count
                const wrapper = document.getElementById('relatedQuestionsWrapper');
                if (wrapper) {
                    wrapper.style.display = 'block';
                }
                console.log(`âœ… Loaded ${totalRelated} related questions (showing ${Math.min(INITIAL_DISPLAY_COUNT, totalRelated)})`);

            } catch (error) {
                console.error('Error loading related questions:', error);
                const container = document.getElementById('relatedQuestionsSection');
                if (container?.parentElement) {
                    container.parentElement.style.display = 'none';
                }
            }
        }

        function toggleRelatedQuestions() {
            relatedQuestionsExpanded = !relatedQuestionsExpanded;
            renderRelatedQuestionsToggle(relatedQuestionsExpanded);
        }

        function renderRelatedQuestionsToggle(showAll) {
            const container = document.getElementById('relatedQuestionsSection');
            const loadMoreContainer = document.getElementById('relatedQuestionsLoadMore');
            if (!container || !loadMoreContainer) return;

            // Helper function to escape HTML
            const escapeHtml = (text) => {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.toString().replace(/[&<>"']/g, m => map[m]);
            };

            // Determine which questions to show
            const questionsToShow = showAll 
                ? allRelatedQuestionsData 
                : allRelatedQuestionsData.slice(0, INITIAL_DISPLAY_COUNT);

            // Render related questions
            const html = questionsToShow.map(q => `
                <a href="comment.html?id=${q.id}" class="related-question-item">
                    <div class="related-question-title">${escapeHtml(q.question)}</div>
                    <div class="related-question-meta">
                        <div class="related-question-tags">
                            ${(q.tags || []).length > 0 
                                ? q.tags.map(tag => `<span class="related-question-tag">${escapeHtml(tag)}</span>`).join('')
                                : ''}
                        </div>
                        <div class="related-question-views">
                            <i class="fas fa-eye"></i> ${q.views} views
                        </div>
                        <span class="related-question-status verified">
                            âœ“ ${q.is_fully_verified ? 'Verified' : 'Verifying'}
                        </span>
                    </div>
                </a>
            `).join('');

            container.innerHTML = html;

            // Show toggle button only if there are more than INITIAL_DISPLAY_COUNT questions
            const hiddenCount = allRelatedQuestionsData.length - INITIAL_DISPLAY_COUNT;
            if (hiddenCount > 0) {
                if (showAll) {
                    loadMoreContainer.innerHTML = `
                        <button class="load-more-btn" onclick="toggleRelatedQuestions()">
                            <i class="fas fa-chevron-up"></i> à¸‹à¹ˆà¸­à¸™à¸„à¸³à¸–à¸²à¸¡
                        </button>
                    `;
                } else {
                    loadMoreContainer.innerHTML = `
                        <button class="load-more-btn" onclick="toggleRelatedQuestions()">
                            <i class="fas fa-chevron-down"></i> à¹‚à¸«à¸¥à¸” ${hiddenCount} à¸„à¸³à¸–à¸²à¸¡
                        </button>
                    `;
                }
            } else {
                loadMoreContainer.innerHTML = '';
            }

            console.log(`âœ… Rendered ${questionsToShow.length}/${allRelatedQuestionsData.length} related questions (expanded: ${showAll})`);
        }

        function setupFilterLinks() {
            // Setup filter link click handlers if they exist
            document.querySelectorAll('.sidebar-link[data-filter]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                });
            });

            // Setup tag click handlers
            document.querySelectorAll('.sidebar-tag-item').forEach(tag => {
                tag.addEventListener('click', () => {
                    tag.classList.toggle('active');
                    // Tag filter functionality can be customized for detail page if needed
                });
            });
        }

        async function getCurrentUser() {
            try {
                const res = await fetch('/auth/session');
                if (!res.ok) throw new Error('Failed to get session');
                const data = await res.json();
                
                const loginBtn = document.getElementById('loginBtn');
                const usernameDisplay = document.getElementById('usernameDisplay');
                
                if (data.loggedIn) {
                    currentUserId = data.userId || null;
                    currentUsername = data.username || 'Guest';
                    
                    if (loginBtn) {
                        loginBtn.textContent = data.isGuest ? 'Login' : 'Logout';
                        loginBtn.href = data.isGuest ? '/auth/login' : '/auth/logout';
                    }
                    
                    if (!data.isGuest && data.username && usernameDisplay) {
                        usernameDisplay.textContent = `Welcome: ${data.username}`;
                        usernameDisplay.style.display = 'inline';
                    } else if (usernameDisplay) {
                        usernameDisplay.style.display = 'none';
                    }
                } else {
                    // Not logged in, redirect to login
                    window.location.href = '/auth/login';
                    return;
                }
            } catch (e) {
                console.log('User not logged in:', e);
                window.location.href = '/auth/login';
            }
        }

        function setupNotificationBell() {
            const bellBtn = document.getElementById('notificationBellBtn');
            const dropdown = document.getElementById('notificationDropdown');
            const closeBtn = document.getElementById('closeNotificationBtn');
            const notificationList = document.getElementById('notificationList');

            if (!bellBtn) return;

            // Toggle dropdown
            bellBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    await loadNotifications();
                } else {
                    dropdown.style.display = 'none';
                }
            });

            // Close dropdown
            closeBtn?.addEventListener('click', () => {
                dropdown.style.display = 'none';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.notification-bell-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        async function loadNotifications() {
            try {
                if (!currentUserId) return;

                const res = await fetch(`/api/get-notifications`);
                const data = await res.json();

                const notificationList = document.getElementById('notificationList');
                const badge = document.getElementById('notificationBadge');

                if (data.success && data.notifications && data.notifications.length > 0) {
                    // Show unread count in badge
                    const unreadCount = data.unreadCount || 0;
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'block' : 'none';

                    notificationList.innerHTML = data.notifications.map(notif => `
                        <div class="notification-item ${!notif.isRead ? 'unread' : ''}" onclick="handleNotificationClick(${notif.id}, ${notif.questionId}, ${notif.isRead})">
                            ${!notif.isRead ? '<div class="notification-unread-indicator"></div>' : ''}
                            <div class="notification-item-avatar">
                                ${notif.verifiedBy ? notif.verifiedBy.charAt(0).toUpperCase() : 'V'}
                            </div>
                            <div class="notification-item-content">
                                <div class="notification-item-title">Answer Verified</div>
                                <div class="notification-item-text">
                                    Your answer was verified by <strong>${notif.verifiedBy || 'User'}</strong> from <strong>${notif.department || 'Department'}</strong>
                                </div>
                                <div class="notification-item-meta">
                                    ${formatDate(notif.createdAt)}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    badge.style.display = 'none';
                    notificationList.innerHTML = '<div class="empty-notifications">No notifications</div>';
                }
            } catch (e) {
                console.error('Error loading notifications:', e);
            }
        }

        async function handleNotificationClick(notificationId, questionId, isRead) {
            try {
                // Mark as read if not already read
                if (!isRead) {
                    await fetch('/api/mark-notification-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notificationId })
                    });
                    
                    // Reload notifications to update badge and UI
                    await loadNotifications();
                }
                
                // Navigate to question
                window.location.href = `comment.html?id=${questionId}`;
            } catch (e) {
                console.error('Error handling notification click:', e);
                // Still navigate even if marking fails
                window.location.href = `comment.html?id=${questionId}`;
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Just now';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        async function loadQuestionDetail() {
            try {
                // Get question ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                currentQuestionId = urlParams.get('id');

                if (!currentQuestionId) {
                    showQuestionError('Question not found. Please go back to community page.');
                    return;
                }

                // Fetch question details
                const res = await fetch('/api/get-all-verified-answers');
                const data = await res.json();
                const questions = data.results || data.answers || [];
                const question = questions.find(q => q.id === parseInt(currentQuestionId));

                if (!question) {
                    showQuestionError('Question not found.');
                    return;
                }

                // Update page title
                document.title = question.question || 'Q&A Detail';

                // Render question detail
                renderQuestionDetail(question);

                // Load attachments
                await loadAttachments(currentQuestionId);

                // Load comments and verifications
                await loadComments();
                await loadVerifications();

                // Increment view
                await incrementView(currentQuestionId);
            } catch (e) {
                console.error('Error loading question:', e);
                showQuestionError('Error loading question. Please try again.');
            }
        }

        // =====================================================
        // ========== AI SUGGESTION FUNCTIONS ==========
        // =====================================================

        /**
         * Load AI suggestion for the current question
         * @param {number} questionId - The question ID
         * @param {string} fallbackAnswer - The original answer to use as fallback
         */
        async function loadAISuggestion(questionId, fallbackAnswer) {
            const aiAnswerContent = document.getElementById('aiAnswerContent');
            if (!aiAnswerContent) return;

            try {
                // First try to get existing AI suggestion
                const res = await fetch(`/api/ai-suggestion/${questionId}`);
                const data = await res.json();

                if (data.success && data.suggestion) {
                    // Display existing AI suggestion
                    renderAISuggestion(data.suggestion, fallbackAnswer);
                } else {
                    // No existing suggestion, try to generate one
                    await generateAISuggestion(questionId, fallbackAnswer);
                }
            } catch (error) {
                console.error('Error loading AI suggestion:', error);
                // Fallback to original answer
                renderAISuggestionFallback(fallbackAnswer);
            }
        }

        /**
         * Generate a new AI suggestion for the question
         */
        async function generateAISuggestion(questionId, fallbackAnswer) {
            const aiAnswerContent = document.getElementById('aiAnswerContent');
            if (!aiAnswerContent) return;

            try {
                // Show generating state
                aiAnswerContent.innerHTML = `
                    <div class="ai-answer-box">
                        <div class="ai-answer-badge generating">
                            <i class="fas fa-cog fa-spin"></i> Generating AI Suggestion...
                        </div>
                        <div class="ai-answer-text">
                            <p style="color: #666;">Analyzing question and searching knowledge base...</p>
                        </div>
                    </div>
                `;

                const res = await fetch('/api/ai-generate-suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: parseInt(questionId),
                        sourceType: 'create_question'
                    })
                });

                const data = await res.json();

                if (data.success && data.suggestion) {
                    renderAISuggestion({
                        answer: data.suggestion.answer,
                        model: data.suggestion.model,
                        confidence: data.suggestion.confidence,
                        sources: data.suggestion.sources,
                        decision: 'pending',
                        id: data.suggestion.id
                    }, fallbackAnswer);
                } else {
                    // Failed to generate, use fallback
                    renderAISuggestionFallback(fallbackAnswer);
                }
            } catch (error) {
                console.error('Error generating AI suggestion:', error);
                renderAISuggestionFallback(fallbackAnswer);
            }
        }

        /**
         * Render AI suggestion with full UI
         */
        function renderAISuggestion(suggestion, fallbackAnswer) {
            const aiAnswerContent = document.getElementById('aiAnswerContent');
            if (!aiAnswerContent) return;

            let answer = suggestion.answer || fallbackAnswer || 'No AI answer available yet';
            const confidence = suggestion.confidence ? Math.round(suggestion.confidence * 100) : null;
            const model = suggestion.model || 'AI';
            const decision = suggestion.decision || 'pending';
            const suggestionId = suggestion.id;
            const sourcesData = suggestion.sources || [];
            
            // ðŸ”„ FILTER & SORT: Keep only sources with >= 65% similarity and sort descending
            const SIMILARITY_THRESHOLD = 0.65; // 65%
            const MAX_SOURCES_DISPLAY = 3; // Top 3 sources
            
            const filteredAndSorted = sourcesData
                .filter(source => !source.similarity || source.similarity >= SIMILARITY_THRESHOLD)
                .sort((a, b) => (b.similarity || 0) - (a.similarity || 0))
                .slice(0, MAX_SOURCES_DISPLAY);
            
            const sourcesCount = filteredAndSorted.length;

            // Format answer - convert newlines to HTML if not already HTML
            if (!answer.includes('<div') && !answer.includes('<p>') && !answer.includes('<ul>')) {
                // Convert plain text with newlines to formatted HTML
                answer = formatPlainTextAnswer(answer);
            }

            // Decision badge styling
            let decisionBadge = '';
            if (decision === 'accepted') {
                decisionBadge = '<span class="decision-badge accepted"><i class="fas fa-check"></i> Accepted</span>';
            } else if (decision === 'modified') {
                decisionBadge = '<span class="decision-badge modified"><i class="fas fa-edit"></i> Modified</span>';
            } else if (decision === 'rejected') {
                decisionBadge = '<span class="decision-badge rejected"><i class="fas fa-times"></i> Rejected</span>';
            }

            // Sources section - clickable to show details
            let sourcesHtml = '';
            if (sourcesCount > 0) {
                // Get current theme for proper colors - define BEFORE building sourcesListHtml
                const isDarkTheme = document.body.getAttribute('data-theme') === 'dark' || localStorage.getItem('theme') === 'dark';
                const sourcesBg = isDarkTheme ? '#2a2a2a' : '#fff';
                const sourcesBorder = isDarkTheme ? '#404040' : '#e0e0e0';
                const sourcesText = isDarkTheme ? '#e0e0e0' : '#555';
                const itemBg = isDarkTheme ? '#333' : '#f8f9fa';
                const itemText = isDarkTheme ? '#e0e0e0' : '#333';
                const itemTextMuted = isDarkTheme ? '#999' : '#666';
                
                // Build sources list HTML
                let sourcesListHtml = filteredAndSorted.map((source, idx) => {
                    const type = source.type || 'unknown';
                    const questionId = source.questionId || '';
                    const question = source.question || '';
                    const verifiedBy = source.verifiedBy || '';
                    const similarity = source.similarity ? Math.round(source.similarity * 100) : null;
                    const fileName = source.fileName || '';
                    
                    let sourceIcon = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                    let sourceLabel = 'Verified Answer';
                    
                    if (type === 'self_verified') {
                        sourceIcon = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                        sourceLabel = 'Self-verified';
                    } else if (type === 'verified_answer' || type === 'verification_comments') {
                        // Expert verified answers
                        sourceIcon = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                        sourceLabel = 'Verified Answer';
                    } else if (type === 'similar_verified') {
                        // Questions with sum_verified_answer (synthesized)
                        sourceIcon = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                        sourceLabel = 'Verified Answer';
                    } else if (type === 'similar_unverified') {
                        sourceIcon = '<i class="fas fa-clock" style="color: #ffc107;"></i>';
                        sourceLabel = 'Similar Question (Pending)';
                    } else if (type === 'expert_verification') {
                        sourceIcon = '<i class="fas fa-check-circle" style="color: #28a745;"></i>';
                        sourceLabel = 'Expert Verification';
                    } else if (type === 'attachment_image') {
                        sourceIcon = '<i class="fas fa-image" style="color: #6f42c1;"></i>';
                        sourceLabel = 'Attached Image';
                    } else if (type === 'attachment_document') {
                        sourceIcon = '<i class="fas fa-file-pdf" style="color: #dc3545;"></i>';
                        sourceLabel = 'Attached Document';
                    }
                    
                    // Build display text based on available data
                    let displayText = '';
                    if (questionId && question) {
                        displayText = `<a href="comment.html?id=${questionId}" class="source-question-link" target="_blank">${question}</a>`;
                    } else if (question) {
                        displayText = question;
                    } else if (fileName) {
                        displayText = `<i class="fas fa-file"></i> ${fileName}`;
                    } else if (verifiedBy) {
                        displayText = `Verified by ${verifiedBy}`;
                    } else {
                        displayText = sourceLabel;
                    }
                    
                    const similarityBadge = similarity ? `<span class="source-similarity-badge">${similarity}% match</span>` : '';
                    
                    return `
                        <div class="ai-source-item" style="padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #017374; background: ${itemBg};">
                            <div class="ai-source-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                ${sourceIcon}
                                <span class="ai-source-label" style="font-weight: 500; font-size: 12px; color: ${itemText};">${sourceLabel}</span>
                                ${similarityBadge}
                            </div>
                            <div class="ai-source-question" style="font-size: 13px; color: ${itemText};">
                                ${displayText}
                            </div>
                            ${verifiedBy ? `<div class="ai-source-verified-by" style="font-size: 11px; color: ${itemTextMuted}; margin-top: 4px;"><i class="fas fa-user" style="margin-right: 4px;"></i>${verifiedBy}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                sourcesHtml = `
                    <div class="ai-sources" style="margin-top: 12px;">
                        <div onclick="toggleSourcesDetails()" class="ai-sources-toggle" style="cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; padding: 8px 12px; border-radius: 6px; background: ${sourcesBg}; border: 1px solid ${sourcesBorder}; color: ${sourcesText};">
                            <i class="fas fa-database" style="color: #017374;"></i>
                            <span>Referenced from ${sourcesCount} verified answer${sourcesCount > 1 ? 's' : ''}</span>
                            <i class="fas fa-chevron-down" id="sourcesToggleIcon" style="margin-left: auto; transition: transform 0.3s;"></i>
                        </div>
                        <div id="sourcesDetailsList" class="ai-sources-details" style="display: none; margin-top: 8px; padding: 10px; border-radius: 8px; background: ${sourcesBg}; border: 1px solid ${sourcesBorder};">
                            <div class="ai-sources-title" style="font-weight: 600; margin-bottom: 10px; font-size: 13px; color: ${sourcesText};">
                                <i class="fas fa-list"></i> Sources:
                            </div>
                            ${sourcesListHtml}
                        </div>
                    </div>
                `;
            }

            aiAnswerContent.innerHTML = `
                <div class="ai-answer-box ${decision !== 'pending' ? 'reviewed' : ''}">
                    <div class="ai-answer-header" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                        <div class="ai-answer-badge">
                            <i class="fas fa-sparkles"></i> AI GENERATED
                            ${confidence !== null ? `<span class="confidence-badge">${confidence}% CONFIDENCE</span>` : ''}
                        </div>
                        ${decisionBadge}
                    </div>
                    <div class="ai-answer-text">
                        ${answer}
                    </div>
                    ${sourcesHtml}
                    <div class="ai-answer-meta">
                        <small>Generated by ${model} â€¢ This answer requires verification</small>
                    </div>
                </div>
            `;
        }

        /**
         * Toggle sources details visibility
         */
        function toggleSourcesDetails() {
            const detailsList = document.getElementById('sourcesDetailsList');
            const toggleIcon = document.getElementById('sourcesToggleIcon');
            
            if (detailsList && toggleIcon) {
                if (detailsList.style.display === 'none') {
                    detailsList.style.display = 'block';
                    toggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    detailsList.style.display = 'none';
                    toggleIcon.style.transform = 'rotate(0deg)';
                }
            }
        }

        /**
         * Format plain text answer to HTML with proper formatting
         */
        function formatPlainTextAnswer(text) {
            if (!text) return '';
            
            // Clean up excessive whitespace first
            let formatted = text
                .replace(/\r\n/g, '\n')  // Normalize line endings
                .replace(/\n{3,}/g, '\n\n')  // Max 2 consecutive newlines
                .trim();
            
            // Convert markdown-style headers (must be before other formatting)
            formatted = formatted
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>');
            
            // Convert bold text with colon as section title (e.g., **à¸«à¸±à¸§à¸‚à¹‰à¸­:**)
            formatted = formatted.replace(/\*\*([^*]+?):\*\*/g, '<strong>$1:</strong>');
            
            // Convert remaining bold
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert italic (but not bullet points)
            formatted = formatted.replace(/(?<!\n)\*([^*\n]+?)\*/g, '<em>$1</em>');
            
            // Convert bullet points: lines starting with - or * followed by space
            formatted = formatted.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive <li> in <ul>
            formatted = formatted.replace(/(<li>[\s\S]*?<\/li>)(\n<li>[\s\S]*?<\/li>)*/g, function(match) {
                return '<ul>' + match.replace(/\n/g, '') + '</ul>';
            });
            
            // Convert numbered lists
            formatted = formatted.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            
            // Convert line breaks to <br> (but not before/after block elements)
            formatted = formatted.replace(/\n(?!<)/g, '<br>\n');
            formatted = formatted.replace(/<br>\n(<ul>|<\/ul>|<li>|<\/li>|<h)/g, '\n$1');
            formatted = formatted.replace(/(<\/ul>|<\/h\d>)<br>/g, '$1');
            
            return formatted;
        }

        /**
         * Render fallback when no AI suggestion available
         */
        function renderAISuggestionFallback(fallbackAnswer) {
            const aiAnswerContent = document.getElementById('aiAnswerContent');
            if (!aiAnswerContent) return;

            let formattedAnswer = fallbackAnswer || 'No AI answer available yet';
            if (!formattedAnswer.includes('<div') && !formattedAnswer.includes('<p>')) {
                formattedAnswer = formatPlainTextAnswer(formattedAnswer);
            }

            aiAnswerContent.innerHTML = `
                <div class="ai-answer-box">
                    <div class="ai-answer-badge">
                        <i class="fas fa-sparkles"></i> AI GENERATED
                    </div>
                    <div class="ai-answer-text">
                        ${formattedAnswer}
                    </div>
                    <div class="ai-answer-meta">
                        <small>This answer was generated by AI and requires verification</small>
                    </div>
                </div>
            `;
        }

        // =====================================================
        // ========== END AI SUGGESTION FUNCTIONS ==========
        // =====================================================

        function renderQuestionDetail(q) {
            currentQuestion = q; // Store for verify button visibility check
            
            console.log('ðŸ” renderQuestionDetail called with:', q);
            console.log('ðŸ” verification_type:', q.verification_type);
            console.log('ðŸ” requested_departments_list:', q.requested_departments_list);
            
            // Ensure requested_departments_list is an array
            let deptsList = [];
            if (q.requested_departments_list) {
                if (Array.isArray(q.requested_departments_list)) {
                    deptsList = q.requested_departments_list;
                } else if (typeof q.requested_departments_list === 'string') {
                    // Handle string format (could be JSON array string or comma-separated)
                    try {
                        deptsList = JSON.parse(q.requested_departments_list);
                        if (!Array.isArray(deptsList)) deptsList = [q.requested_departments_list];
                    } catch (e) {
                        deptsList = q.requested_departments_list.split(',').map(d => d.trim());
                    }
                }
            }
            
            console.log('ðŸ” deptsList:', deptsList);
            
            // Initial badge and pending info (will be updated after verifications load)
            const verificationBadge = q.verification_type === 'request' && deptsList && deptsList.length > 0
                ? '<span class="detail-verified-badge pending" id="verificationBadge">â³ Pending</span>'
                : (q.rating_count || 0) > 0 
                ? '<span class="detail-verified-badge verified" id="verificationBadge">âœ“ Verified</span>'
                : '';

            const pendingInfo = q.verification_type === 'request' && deptsList && deptsList.length > 0
                ? `<div class="detail-pending-info" id="pendingInfo">
                    <i class="fas fa-hourglass-end"></i> Pending verification from: ${deptsList.join(', ')}
                    <button class="view-status-btn" onclick="showVerificationStatus()">View verification status</button>
                   </div>`
                : '';

            console.log('ðŸ” pendingInfo:', pendingInfo);

            // Render Main Question (Left Column)
            document.getElementById('questionDetail').innerHTML = `
                <div class="question-with-vote">
                    <div class="vote-section">
                        <button class="vote-btn vote-up" data-vote="1" title="This question is useful">
                            <i class="fas fa-caret-up"></i>
                        </button>
                        <div class="vote-count" id="questionVoteCount" style="min-height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; padding: 4px 8px;" data-vote="0" title="Click to remove your vote">0</div>
                        <button class="vote-btn vote-down" data-vote="-1" title="This question is not useful">
                            <i class="fas fa-caret-down"></i>
                        </button>
                    </div>
                    <div class="question-content-area">
                        <div class="detail-question-box">
                            <div class="detail-question-title">${q.question || q.question_title || 'Untitled'}</div>
                            
                            <div class="detail-question-meta">
                        <div class="detail-meta-item">
                            <div class="detail-meta-avatar">${(q.created_by || q.user_name || 'U')[0].toUpperCase()}</div>
                            <div class="detail-meta-user">
                                <span class="detail-meta-name">${q.created_by || q.user_name || 'Anonymous'}</span>
                                <span class="detail-meta-time">${formatDate(q.created_at)}</span>
                            </div>
                        </div>
                        <div class="detail-meta-item">
                            <i class="fas fa-eye"></i> ${q.views || 0} views
                        </div>
                    </div>

                    <div class="detail-question-content">${formatPlainTextAnswer(q.answer || 'No content available')}</div>

                    <div id="attachmentsSection" class="detail-attachments-section"></div>

                    ${pendingInfo}

                    <!-- Quick Verification Section for Departments -->
                    <div id="quickVerificationSection" class="quick-verification-section" style="display: none;">
                        <div class="verification-title">Verify this answer "by my department"</div>
                        
                        <!-- Department Selection Box -->
                        <div class="verification-dept-section">
                            <label class="verification-label">Select Department <span style="color: red;">*</span></label>
                            <div id="verificationDeptBox" class="verification-dept-box">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="verification-buttons">
                            <button class="verify-btn helpful" onclick="submitVerification(1)">
                                <i class="fas fa-thumbs-up"></i> Helpful
                            </button>
                            <button class="verify-btn neutral" onclick="submitVerification(0)">
                                <i class="fas fa-minus"></i> Neutral
                            </button>
                            <button class="verify-btn not-helpful" onclick="submitVerification(-1)">
                                <i class="fas fa-thumbs-down"></i> Not Helpful
                            </button>
                        </div>
                        <textarea id="verificationComment" class="verification-comment" placeholder="Add a comment (optional)..." rows="2"></textarea>
                        <button class="submit-verification-btn" onclick="submitVerificationWithComment()">Submit Verification</button>
                    </div>

                    <div class="detail-question-actions">
                        <button class="detail-action-btn" onclick="shareQuestion()">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                        </div>
                    </div>
                </div>
            `;

            // Render AI Answer (Right Column) - Now loads from AI Suggestions API
            const aiAnswerContent = document.getElementById('aiAnswerContent');
            if (aiAnswerContent) {
                // Show loading state first
                aiAnswerContent.innerHTML = `
                    <div class="ai-answer-box">
                        <div class="ai-answer-badge">
                            <i class="fas fa-sparkles"></i> AI Generated
                        </div>
                        <div class="ai-answer-text">
                            <div style="display: flex; align-items: center; gap: 10px; color: #666;">
                                <div class="spinner" style="width: 16px; height: 16px;"></div>
                                Loading AI suggestion...
                            </div>
                        </div>
                    </div>
                `;
                
                // Load AI suggestion from API
                loadAISuggestion(currentQuestionId, q.answer);
            }

            // Render Verification Status (Right Column) - Will be populated after loadVerifications()
            const verStatusContent = document.getElementById('verificationStatusContent');
            if (verStatusContent) {
                verStatusContent.innerHTML = ''; // Empty initially, will be filled by updateVerificationRightColumn
            }

            // Setup vote button event listeners
            setupVoteButtons();
            
            // Setup verification rating buttons
            setupVerificationButtons();
        }

        function setupVoteButtons() {
            const voteButtons = document.querySelectorAll('.vote-btn');
            voteButtons.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const vote = parseInt(this.getAttribute('data-vote'));
                    await voteQuestion(vote);
                });
            });
            
            // Add click handler for vote count (0 button)
            const voteCountEl = document.getElementById('questionVoteCount');
            if (voteCountEl) {
                voteCountEl.addEventListener('click', async function() {
                    const vote = parseInt(this.getAttribute('data-vote'));
                    await voteQuestion(vote);
                });
            }
        }
        // Load and display attachments
        async function loadAttachments(questionId) {
            try {
                const res = await fetch(`/api/question-attachments/${questionId}`);
                if (!res.ok) {
                    console.warn('Could not load attachments');
                    return;
                }
                
                const data = await res.json();
                const attachments = data.attachments || [];
                const attachmentsSection = document.getElementById('attachmentsSection');
                
                if (!attachmentsSection) return;
                
                if (attachments.length === 0) {
                    attachmentsSection.style.display = 'none';
                    return;
                }
                
                attachmentsSection.style.display = 'block';
                attachmentsSection.innerHTML = `
                    <div class="attachments-link" onclick="showAttachmentsModal(${JSON.stringify(attachments).replace(/"/g, '&quot;')})">
                        <i class="fas fa-paperclip"></i> Attachments (${attachments.length})
                    </div>
                `;
            } catch (e) {
                console.error('Error loading attachments:', e);
            }
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'fa-image';
            if (mimeType === 'application/pdf') return 'fa-file-pdf';
            if (mimeType.includes('word')) return 'fa-file-word';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'fa-file-excel';
            if (mimeType === 'text/plain') return 'fa-file-alt';
            return 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function previewAttachment(attachmentId, mimeType, fileName) {
            try {
                if (mimeType.startsWith('image/')) {
                    // Open image in modal
                    const res = await fetch(`/api/attachment-preview/${attachmentId}`);
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        
                        // Create modal
                        const modal = document.createElement('div');
                        modal.className = 'image-preview-modal';
                        modal.innerHTML = `
                            <div class="image-preview-content">
                                <button class="modal-close-btn" onclick="this.closest('.image-preview-modal').remove()">Ã—</button>
                                <img src="${url}" alt="${fileName}" style="max-width: 90%; max-height: 90%; border-radius: 8px;">
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                } else if (mimeType === 'application/pdf') {
                    // Open PDF in new tab (browser will show preview)
                    window.open(`/api/attachment-preview/${attachmentId}`, '_blank');
                } else {
                    // For other files, open in new tab (browser default preview/download)
                    window.open(`/api/attachment-preview/${attachmentId}`, '_blank');
                }
            } catch (e) {
                console.error('Error previewing attachment:', e);
                alert('Failed to preview file. Please try again.');
            }
        }

        // Show attachments in a simple modal
        function showAttachmentsModal(attachments) {
            // Remove existing modal if any
            const existing = document.getElementById('attachmentsModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'attachmentsModal';
            modal.className = 'attachments-modal-overlay';
            modal.innerHTML = `
                <div class="attachments-modal">
                    <div class="attachments-modal-header">
                        <span><i class="fas fa-paperclip"></i> Attachments (${attachments.length})</span>
                        <button onclick="document.getElementById('attachmentsModal').remove()">&times;</button>
                    </div>
                    <div class="attachments-modal-body">
                        ${attachments.map(att => `
                            <div class="attachments-modal-item" onclick="previewAttachment(${att.id}, '${att.mime_type}', '${att.file_name}')">
                                <i class="fas ${getFileIcon(att.mime_type)}"></i>
                                <span>${att.file_name}</span>
                                <small>${formatFileSize(att.file_size_bytes)}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function setupVerificationButtons() {
            // Setup rating button selection
            const ratingBtns = document.querySelectorAll('.verify-btn');
            ratingBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    ratingBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Setup submit verification button
            const submitBtn = document.getElementById('submitVerificationBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitVerification);
            }
        }

        async function voteQuestion(vote) {
            if (!currentUserId) {
                alert('Please login to vote');
                return;
            }

            try {
                const res = await fetch(`/api/vote-question/${currentQuestionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote })
                });

                if (res.ok) {
                    const data = await res.json();
                    const voteCountEl = document.getElementById('questionVoteCount');
                    if (voteCountEl) {
                        // Show user's own vote (-1, 0, or 1), not the total score
                        voteCountEl.textContent = data.userVote || 0;
                        voteCountEl.className = 'vote-count';
                        if (data.userVote > 0) voteCountEl.classList.add('positive');
                        if (data.userVote < 0) voteCountEl.classList.add('negative');
                    }

                    // Update button states
                    document.querySelectorAll('.vote-btn').forEach(btn => {
                        btn.classList.remove('upvoted', 'downvoted');
                    });
                    
                    if (data.userVote === 1) {
                        document.querySelector('.vote-up').classList.add('upvoted');
                    } else if (data.userVote === -1) {
                        document.querySelector('.vote-down').classList.add('downvoted');
                    }
                } else {
                    const error = await res.json();
                    alert(error.error || 'Failed to vote');
                }
            } catch (e) {
                console.error('Error voting:', e);
                alert('Failed to vote');
            }
        }

        async function loadComments() {
            try {
                const res = await fetch(`/api/get-comments/${currentQuestionId}`);
                if (res.ok) {
                    const data = await res.json();
                    comments = data.comments || [];
                    console.log('ðŸ“ Loaded comments:', comments.length);
                } else {
                    console.error('Failed to load comments');
                    comments = [];
                }
                renderComments();
            } catch (e) {
                console.error('Error loading comments:', e);
                comments = [];
                renderComments();
            }
        }

        async function loadVerifications() {
            try {
                const res = await fetch(`/api/get-verifications/${currentQuestionId}`);
                console.log('ðŸŒ API Response status:', res.status);
                if (res.ok) {
                    const data = await res.json();
                    console.log('ðŸŒ API Response data:', data);
                    verifications = data.verifications || [];
                    console.log('âœ… Loaded verifications:', verifications.length, verifications);
                    
                    // Check if current user already rated
                    if (currentUserId) {
                        const myRating = verifications.find(v => v.userId === currentUserId);
                        if (myRating) {
                            userRating = myRating.rating;
                            highlightUserRating(userRating);
                        }
                    }
                    
                    // Update verification status display
                    updateVerificationStatus();
                } else {
                    verifications = [];
                }
                renderVerifications();
            } catch (e) {
                console.error('Error loading verifications:', e);
                verifications = [];
                renderVerifications();
            }
        }

        function updateVerificationStatus() {
            // Update the pending banner after verifications are loaded
            if (!currentQuestion || !currentQuestion.requested_departments_list || currentQuestion.requested_departments_list.length === 0) {
                return;
            }
            
            // Update verification status based on department verification
            console.log('ðŸ” Step 1: All verifications loaded:', verifications.length, verifications);
            
            const requestedDepts = currentQuestion.requested_departments_list || [];
            const verificationDepts = verifications
                .filter(v => v.verification_type === 'verification')
                .map(v => v.requested_departments)
                .flat();
            const verifiedDepts = verifications
                .filter(v => v.verification_type === 'verification')
                .map(v => v.requested_departments ? v.requested_departments[0] : null)
                .filter(Boolean);
            
            console.log('ðŸ” Step 2: Verification departments:', verificationDepts);
            console.log('ðŸ” Verified Departments:', verifiedDepts);
            
            const allDepartmentsVerified = requestedDepts.every(dept => 
                verificationDepts.includes(dept)
            );
            
            console.log('ðŸ”„ Updating verification banner:', {
                requestedDepts: currentQuestion.requested_departments_list,
                verifiedDepts: verifiedDepts,
                allVerified: allDepartmentsVerified
            });
            
            // Update badge and pending info
            const badgeEl = document.getElementById('verificationBadge');
            const pendingInfoEl = document.getElementById('pendingInfo');
            
            if (badgeEl && currentQuestion.verification_type === 'verification') {
                if (allDepartmentsVerified) {
                    // All verified - change to green and show departments
                    badgeEl.className = 'detail-verified-badge verified';
                    badgeEl.innerHTML = `âœ“ Verified from: ${verifiedDepts.join(', ')}`;
                    // Hide pending info
                    if (pendingInfoEl) {
                        pendingInfoEl.style.display = 'none';
                    }
                } else {
                    // Still pending - keep yellow
                    badgeEl.className = 'detail-verified-badge pending';
                    badgeEl.innerHTML = 'â³ Pending';
                    // Show pending info
                    if (pendingInfoEl) {
                        pendingInfoEl.style.display = 'flex';
                    }
                }
            }
            
            // Update right column verification section
            updateVerificationRightColumn();
        }

        function updateVerificationRightColumn() {
            const verStatusContent = document.getElementById('verificationStatusContent');
            if (!verStatusContent || !currentQuestion) {
                return;
            }
            
            // Build verification items from loaded verifications
            let verificationItemsHTML = '';
            
            console.log('ðŸ” Building verification items from:', verifications);
            
            if (verifications && verifications.length > 0) {
                const verifiedDepartments = {};
                
                // Extract verified departments from verifications
                // Filter out auto-generated "Self" verifications for self-verified questions
                const realVerifications = verifications.filter(v => {
                    const depts = v.requestedDepartments || v.requested_departments || [];
                    const dept = typeof depts === 'string' ? depts : (Array.isArray(depts) ? depts[0] : depts);
                    const comment = v.comment || v.text || '';
                    
                    // Skip auto-generated "Self" verifications (from auto-verification for self-verified)
                    if (dept === 'Self' && comment === 'Self-verified by author') {
                        console.log('â­ï¸ Skipping auto-generated Self verification');
                        return false;
                    }
                    return true;
                });
                
                realVerifications.forEach(v => {
                    // Log all properties to understand the structure
                    console.log('ðŸ“‹ Full verification object:', JSON.stringify(v, null, 2));
                    
                    // Check for verification type (could be 'verification' or check for other indicators)
                    const isVerification = v.verification_type === 'verification' || 
                                         v.verificationType === 'verification' ||
                                         (v.requestedDepartments && v.requestedDepartments.length > 0);
                    
                    // Check both possible property names for departments
                    const depts = v.requestedDepartments || v.requested_departments || [];
                    
                    console.log('ðŸ”Ž Is verification?', isVerification, 'Departments:', depts);
                    
                    if (isVerification && depts && depts.length > 0) {
                        const dept = typeof depts === 'string' ? depts : (Array.isArray(depts) ? depts[0] : depts);
                        if (dept && !verifiedDepartments[dept]) {
                            verifiedDepartments[dept] = {
                                username: v.username || v.user_name || 'Unknown',
                                date: new Date(v.createdAt || v.created_at).toLocaleDateString('en-GB', {
                                    day: '2-digit',
                                    month: 'short'
                                })
                            };
                            console.log('âœ… Added verified department:', dept);
                        }
                    }
                });
                
                // Display verified departments
                console.log('ðŸ“Š Verified departments found:', Object.keys(verifiedDepartments).length);
                if (Object.keys(verifiedDepartments).length > 0) {
                    verificationItemsHTML = realVerifications
                        .filter(v => {
                            const depts = v.requestedDepartments || v.requested_departments || [];
                            return v.verification_type === 'verification' || 
                                   v.verificationType === 'verification' ||
                                   (depts && depts.length > 0);
                        })
                        .map(v => {
                            const depts = v.requestedDepartments || v.requested_departments || [];
                            const dept = typeof depts === 'string' ? depts : (Array.isArray(depts) ? depts[0] : depts);
                            const username = v.username || v.user_name || 'Unknown';
                            const date = new Date(v.createdAt || v.created_at).toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: 'short'
                            });
                            const comment = (v.comment || v.text || '')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/\n/g, '<br>');
                            const attachments = v.attachments || [];
                            console.log('ðŸ”Ž Verification attachments:', 'id:', v.id, 'count:', attachments.length, 'data:', attachments);
                            
                            // Build attachments HTML
                            let attachmentsHtml = '';
                            if (attachments && Array.isArray(attachments) && attachments.length > 0) {
                                const attachmentItems = attachments.map(att => {
                                    const ext = att.name?.split('.').pop().toLowerCase() || '';
                                    const mimeType = att.type || 'application/octet-stream';
                                    const sizeKB = att.size ? Math.round(att.size / 1024) : 0;
                                    const fileUrl = att.url || '';
                                    return `
                                    <div class="verification-attachment-item">
                                        <div class="verification-attachment-info">
                                            <i class="fas ${(() => {
                                                if (mimeType.startsWith('image/')) return 'fa-image';
                                                if (mimeType === 'application/pdf') return 'fa-file-pdf';
                                                if (mimeType.includes('word')) return 'fa-file-word';
                                                if (mimeType.includes('sheet')) return 'fa-file-excel';
                                                return 'fa-file';
                                            })()}"></i>
                                            <div class="verification-attachment-details">
                                                <div class="verification-attachment-name">${att.name || 'file'}</div>
                                                <div class="verification-attachment-meta">${sizeKB > 0 ? sizeKB + ' KB' : ''}</div>
                                            </div>
                                        </div>
                                        <button class="verification-attachment-preview-btn" onclick="window.open('${fileUrl}', '_blank')" title="Preview file">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                    </div>`;
                                }).join('');
                                attachmentsHtml = `<div class="verification-attachments-list">${attachmentItems}</div>`;
                            }
                            
                            // Don't show "Request:" prefix for self-verified questions
                            const isSelfVerified = currentQuestion.verification_type === 'self';
                            const prefix = isSelfVerified ? '' : 'Request: ';
                            
                            return `
                                <div class="verification-item verified">
                                    <div class="verification-item-header">
                                        <div class="verification-item-text">
                                            ${prefix}âœ“ Verified from ${dept} - ${username} (${date})
                                        </div>
                                    </div>
                                    ${comment ? `<div class="verification-item-comment">${comment}</div>` : ''}
                                    ${attachmentsHtml}
                                </div>
                            `;
                        }).join('');
                }
            }
            
            console.log('ðŸŽ¯ Final verificationItemsHTML:', verificationItemsHTML ? 'Has items' : 'Empty');
            
            // Rebuild the verification section
            const deptsList = currentQuestion.requested_departments_list || [];
            
            // If there are verification items, show ONLY those items
            if (verificationItemsHTML) {
                console.log('âœ¨ Showing verification items ONLY');
                const verStatus = `<div class="verification-items-only">
                    ${verificationItemsHTML}
                </div>`;
                verStatusContent.innerHTML = verStatus;
                return;
            }
            
            // Otherwise show the pending status or other states
            const verStatus = currentQuestion.verification_type === 'request' && deptsList.length > 0
                ? `<div class="verification-status-box pending">
                    <div class="verification-status-badge pending">
                        <i class="fas fa-hourglass-end"></i> Pending
                    </div>
                    <div class="verification-status-details">
                        <p><strong>Waiting for verification from:</strong></p>
                        <div class="departments-list">
                            ${deptsList.map(dept => `
                                <span class="dept-chip">
                                    <i class="fas fa-circle"></i> ${dept}
                                </span>
                            `).join('')}
                        </div>
                        <button class="verification-status-btn" onclick="showVerificationStatus()">
                            <i class="fas fa-eye"></i> View Status
                        </button>
                    </div>
                </div>`
                : (currentQuestion.rating_count || 0) > 0
                ? `<div class="verification-status-box verified">
                    <div class="verification-status-badge verified">
                        <i class="fas fa-check-circle"></i> Verified
                    </div>
                    <div class="verification-status-details">
                        <p><strong>Verified by departments:</strong></p>
                        <div class="verification-count">
                            <span class="count-badge">${currentQuestion.rating_count || 0}</span> verification(s)
                        </div>
                    </div>
                    <div class="verification-items">
                        ${verificationItemsHTML}
                    </div>
                </div>`
                : `<div class="verification-status-box unverified">
                    <div class="verification-status-badge">
                        <i class="fas fa-question-circle"></i> Unverified
                    </div>
                    <div class="verification-status-details">
                        <p>This answer has not been verified yet.</p>
                    </div>
                </div>`;
            
            verStatusContent.innerHTML = verStatus;
        }

        function renderVerifications() {
            const count = verifications.length;
            
            // Only update if elements exist (Verifications section was removed)
            const verCountEl = document.getElementById('verificationCount');
            const verListEl = document.getElementById('verificationsList');
            
            if (!verCountEl || !verListEl) {
                console.log('â„¹ï¸ Verifications elements not found (section removed)');
                return;
            }
            
            verCountEl.textContent = count;

            if (count === 0) {
                verListEl.innerHTML = `
                    <div class="empty-verifications">
                        <div class="empty-icon">ðŸ”</div>
                        <p>No verifications yet</p>
                    </div>
                `;
                return;
            }

            verListEl.innerHTML = verifications.map(v => {
                // Debug attachments
                console.log('ðŸ” Rendering verification:', v.id, 'attachments:', v.attachments);
                
                // Rating display
                let ratingDisplay = '';
                let ratingClass = '';
                if (v.rating === 1) {
                    ratingDisplay = '<i class="fas fa-thumbs-up"></i> Helpful (+1)';
                    ratingClass = 'rating-positive';
                } else if (v.rating === -1) {
                    ratingDisplay = '<i class="fas fa-thumbs-down"></i> Not Helpful (-1)';
                    ratingClass = 'rating-negative';
                } else if (v.rating === 0) {
                    ratingDisplay = '<i class="fas fa-minus"></i> Neutral (0)';
                    ratingClass = 'rating-neutral';
                } else {
                    ratingDisplay = `<i class="fas fa-star"></i> Score: ${v.rating}`;
                    ratingClass = v.rating > 0 ? 'rating-positive' : (v.rating < 0 ? 'rating-negative' : 'rating-neutral');
                }

                // Type badge
                let typeBadge = '';
                if (v.verificationType === 'request') {
                    const depts = (v.requestedDepartments || []).join(', ');
                    typeBadge = `<span class="type-badge pending">â³ Request (${depts || 'N/A'})</span>`;
                } else if (v.verificationType === 'self') {
                    typeBadge = '<span class="type-badge verified">âœ“ Self Verified</span>';
                } else if (v.verificationType === 'rating') {
                    typeBadge = '<span class="type-badge rating">â­ Quick Rating</span>';
                }

                // Attachments display
                let attachmentsHtml = '';
                if (v.attachments && Array.isArray(v.attachments) && v.attachments.length > 0) {
                    attachmentsHtml = `
                        <div class="comment-attachments-list">
                            ${v.attachments.map(att => {
                                const ext = att.name?.split('.').pop().toLowerCase() || '';
                                const mimeType = att.type || (() => {
                                    const mimeMap = {
                                        'pdf': 'application/pdf',
                                        'png': 'image/png',
                                        'jpg': 'image/jpeg',
                                        'jpeg': 'image/jpeg',
                                        'gif': 'image/gif',
                                        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                        'txt': 'text/plain'
                                    };
                                    return mimeMap[ext] || 'application/octet-stream';
                                })();
                                const sizeKB = att.size ? Math.round(att.size / 1024) : 0;
                                const fileUrl = att.url || '';
                                return `
                                <div class="comment-attachment-item">
                                    <div class="comment-attachment-info">
                                        <i class="fas ${(() => {
                                            if (mimeType.startsWith('image/')) return 'fa-image';
                                            if (mimeType === 'application/pdf') return 'fa-file-pdf';
                                            if (mimeType.includes('word')) return 'fa-file-word';
                                            if (mimeType.includes('sheet')) return 'fa-file-excel';
                                            return 'fa-file';
                                        })()}"></i>
                                        <div class="comment-attachment-details">
                                            <div class="comment-attachment-name">${att.name || 'file'}</div>
                                            <div class="comment-attachment-meta">${sizeKB > 0 ? sizeKB + ' KB' : ''}</div>
                                        </div>
                                    </div>
                                    <button class="comment-attachment-preview-btn" onclick="window.open('${fileUrl}', '_blank')" title="Preview file">
                                        <i class="fas fa-eye"></i> Preview
                                    </button>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="verification-item">
                        <div class="verification-header">
                            <div class="verification-user">
                                <div class="verification-avatar">${(v.username || 'U')[0].toUpperCase()}</div>
                                <div class="verification-user-info">
                                    <span class="verification-username">${v.username || 'Anonymous'}</span>
                                    <span class="verification-time">${formatDate(v.createdAt)}</span>
                                </div>
                            </div>
                            <div class="verification-rating ${ratingClass}">${ratingDisplay}</div>
                        </div>
                        ${typeBadge ? `<div class="verification-type">${typeBadge}</div>` : ''}
                        ${v.comment ? `<div class="verification-comment">${v.comment}</div>` : ''}
                        ${attachmentsHtml}
                    </div>
                `;
            }).join('');
        }

        function setupRatingButtons() {
            const ratingBtns = document.querySelectorAll('.quick-rate-btn');
            ratingBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!currentUserId) {
                        showRatingMessage('Please login to rate this answer', 'error');
                        return;
                    }
                    
                    const rating = parseInt(btn.dataset.rating);
                    await rateAnswer(rating);
                });
            });
        }

        // Setup Verification Departments Selection
        const AVAILABLE_DEPARTMENTS = ['WT', 'FT', 'P', 'LOG', 'OE', 'IT', 'Other'];
        
        function setupVerificationDepartments() {
            const deptBox = document.getElementById('verificationDeptBox');
            if (!deptBox) return;
            
            deptBox.innerHTML = AVAILABLE_DEPARTMENTS.map(dept => `
                <div class="verification-dept-radio">
                    <input type="radio" name="verificationDept" class="verification-dept-radio-input" value="${dept}" />
                    <label>${dept}</label>
                </div>
            `).join('');
        }
        
        function getSelectedVerificationDepartments() {
            const deptBox = document.getElementById('verificationDeptBox');
            if (!deptBox) return [];
            
            const selected = deptBox.querySelector('.verification-dept-radio-input:checked');
            return selected ? [selected.value] : [];
        }

        async function rateAnswer(rating) {
            try {
                const response = await fetch('/api/rate-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestionId,
                        rating: rating,
                        userId: currentUserId,
                        username: currentUsername
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userRating = rating;
                    highlightUserRating(rating);
                    showRatingMessage('Rating submitted successfully!', 'success');
                    
                    // Update score display
                    const scoreEl = document.querySelector('.detail-meta-item .fa-star');
                    if (scoreEl) {
                        scoreEl.parentElement.innerHTML = `<i class="fas fa-star"></i> Score: ${data.newScore}`;
                    }
                    
                    // Reload verifications
                    await loadVerifications();
                } else {
                    showRatingMessage('Failed to submit rating', 'error');
                }
            } catch (e) {
                console.error('Error rating:', e);
                showRatingMessage('Error submitting rating', 'error');
            }
        }

        function highlightUserRating(rating) {
            document.querySelectorAll('.quick-rate-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.rating) === rating) {
                    btn.classList.add('selected');
                }
            });
        }

        function showRatingMessage(msg, type) {
            const msgEl = document.getElementById('ratingMessage');
            msgEl.textContent = msg;
            msgEl.className = `quick-rating-message ${type}`;
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 3000);
        }

        function renderComments() {
            try {
                console.log('ðŸŽ¨ Rendering comments...', comments.length, 'total');
                
                // Separate verification comments from regular comments
                const verificationComments = comments.filter(c => c.source === 'verification');
                const regularComments = comments.filter(c => c.source !== 'verification');
                
                console.log('ðŸ“Š Comment breakdown:', {
                    total: comments.length,
                    verifications: verificationComments.length,
                    regular: regularComments.length
                });
                
                const count = regularComments.length;
                const countEl = document.getElementById('commentCount');
                if (countEl) countEl.textContent = count;

                const listEl = document.getElementById('commentsList');
                if (!listEl) {
                    console.error('âŒ commentsList element not found!');
                    return;
                }

                if (count === 0) {
                    listEl.innerHTML = `
                        <div class="empty-comments">
                            <div class="empty-comments-icon">ðŸ’¬</div>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                    `;
                    return;
                }

            let html = '';
            
            // Render regular comments ONLY - verification comments should only appear in the Verification section
            regularComments.forEach(comment => {
                const formattedDate = new Date(comment.createdAt).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short'
                });
                
                const deptLabel = comment.department || 'General';
                const safeText = (comment.text || '')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                
                // Parse attachments if it's a JSON string
                let attachmentsList = [];
                try {
                    if (comment.attachments) {
                        attachmentsList = typeof comment.attachments === 'string' 
                            ? JSON.parse(comment.attachments) 
                            : comment.attachments;
                    }
                } catch (e) {
                    console.warn('Failed to parse attachments:', e);
                    attachmentsList = [];
                }
                console.log('ðŸ“Ž Comment attachments:', comment.id, 'count:', attachmentsList.length, 'data:', attachmentsList);
                
                html += `
                    <div class="comment-item">
                        <div class="comment-dept-header">
                            Comment by ${comment.username || 'Anonymous'} - (${formattedDate})
                        </div>
                        ${comment.text ? `<div class="comment-content">${safeText}</div>` : ''}
                        ${attachmentsList.length > 0 ? (() => {
                            const firstFile = attachmentsList[0];
                            const fileName = firstFile.name || 'Attachment';
                            const displayText = attachmentsList.length > 1 
                                ? `${fileName} and ${attachmentsList.length - 1} more`
                                : fileName;
                            return `
                            <div class="comment-attachments-link">
                                <a href="${firstFile.url}" target="_blank" class="attachment-link">
                                    <i class="fas fa-paperclip"></i> ${displayText}
                                </a>
                            </div>
                            `;
                        })() : ''}
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
            console.log('âœ… Comments rendered successfully');
            } catch (error) {
                console.error('âŒ Error rendering comments:', error);
                const listEl = document.getElementById('commentsList');
                if (listEl) {
                    listEl.innerHTML = '<div class="error-message">Error displaying comments. Please refresh the page.</div>';
                }
            }
        }

        function setupCommentSubmit() {
            const submitBtn = document.getElementById('submitCommentBtn');
            const verifyBtn = document.getElementById('verifyCommentBtn');
            const commentInput = document.getElementById('commentInput');
            const fileInput = document.getElementById('commentAttachment');
            const deptSelect = document.getElementById('commentDept');

            submitBtn.addEventListener('click', submitComment);
            verifyBtn.addEventListener('click', submitVerifyComment);
            
            // Show verify button when user selects department for pending verification
            deptSelect.addEventListener('change', updateVerifyButtonVisibility);
            
            commentInput.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    submitComment();
                }
            });

            // Handle file upload
            fileInput.addEventListener('change', handleFileSelect);

            // Auto-expand textarea
            setupAutoExpandTextarea(commentInput);
        }

        // Auto-expand textarea function
        function setupAutoExpandTextarea(textarea) {
            if (!textarea) return;
            
            const autoExpand = () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            };
            
            textarea.addEventListener('input', autoExpand);
            textarea.addEventListener('focus', autoExpand);
            
            // Initial expansion if there's content
            if (textarea.value) {
                autoExpand();
            }
        }

        let selectedFiles = [];
        let currentQuestion = null;

        function updateVerifyButtonVisibility() {
            const deptSelect = document.getElementById('commentDept');
            const verifyBtn = document.getElementById('verifyCommentBtn');
            const department = deptSelect.value;
            
            // Show verify button if:
            // 1. User is logged in
            // 2. Question has PENDING verification requests (verification_type === 'request')
            // 3. NOT self-verified (verification_type !== 'self')
            // 4. Selected department is in the requested departments list
            if (currentUserId && currentQuestion && department && 
                currentQuestion.verification_type === 'request' &&
                currentQuestion.requested_departments_list && 
                currentQuestion.requested_departments_list.includes(department)) {
                verifyBtn.style.display = 'inline-flex';
            } else {
                verifyBtn.style.display = 'none';
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('attachmentPreview');
            
            selectedFiles = files;
            preview.innerHTML = '';

            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.innerHTML = `
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                    <button type="button" data-index="${index}">Ã—</button>
                `;
                preview.appendChild(item);
            });

            // Add remove listeners
            preview.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const index = parseInt(btn.dataset.index);
                    selectedFiles.splice(index, 1);
                    handleFileSelect({ target: { files: selectedFiles } });
                });
            });
        }

        async function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const deptSelect = document.getElementById('commentDept');
            const text = commentInput.value.trim();
            const department = deptSelect.value;
            const messagesContainer = document.getElementById('messagesContainer');

            if (!text) {
                showMessage('Please write a comment', 'error');
                return;
            }

            if (!currentUserId) {
                showMessage('Please login to comment', 'error');
                return;
            }

            if (!department) {
                showMessage('Please select a department', 'error');
                return;
            }

            try {
                const attachments = [];
                
                console.log('ðŸ“Ž Selected files:', selectedFiles.length);
                
                // Upload files if any
                if (selectedFiles.length > 0) {
                    console.log('ðŸ“¤ Uploading files...');
                    const formData = new FormData();
                    selectedFiles.forEach(file => {
                        console.log('Adding file:', file.name, file.size);
                        formData.append('files', file);
                    });

                    const uploadRes = await fetch('/api/upload-comment-files', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Upload response status:', uploadRes.status);
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        console.log('Upload result:', uploadData);
                        attachments.push(...(uploadData.files || []));
                    } else {
                        console.error('Upload failed:', await uploadRes.text());
                    }
                } else {
                    console.log('âš ï¸ No files selected');
                }

                // Save to backend
                const res = await fetch('/api/add-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestionId,
                        userId: currentUserId,
                        username: currentUsername,
                        text: text,
                        department: department,
                        attachments: attachments
                    })
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Server error:', errorText);
                    throw new Error('Failed to save comment');
                }

                const data = await res.json();
                console.log('Comment response:', data);
                
                if (data.success && data.comment) {
                    // Reload all comments from server to ensure consistency
                    await loadComments();
                    
                    // Clear form
                    commentInput.value = '';
                    deptSelect.value = '';
                    selectedFiles = [];
                    document.getElementById('attachmentPreview').innerHTML = '';
                    document.getElementById('commentAttachment').value = '';
                    showMessage('Comment added successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (e) {
                console.error('Error submitting comment:', e);
                showMessage('Error adding comment. Please try again.', 'error');
            }
        }

        function showMessage(text, type) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `${type}-message`;
            messageEl.textContent = text;
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 3000);
        }

        async function incrementView(questionId) {
            try {
                await fetch('/api/increment-view', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId })
                });
            } catch (e) {
                console.log('View count increment failed:', e);
            }
        }

        function verifyAnswer() {
            // Redirect to community page with verify modal
            window.location.href = `community.html?verify=${currentQuestionId}`;
        }

        function shareQuestion() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'Check this Q&A',
                    text: 'Take a look at this interesting question and answer',
                    url: url
                }).catch(err => console.log('Share failed:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    showMessage('Link copied to clipboard!', 'success');
                }).catch(() => {
                    showMessage('Could not copy link', 'error');
                });
            }
        }

        function showQuestionError(message) {
            document.getElementById('questionDetail').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> ${esc(message)}
                </div>
            `;
        }

        // Sidebar Toggle Functionality
        function setupSidebarToggle() {
            const toggleBtn = document.getElementById('toggleSidebarButton');
            const chatList = document.getElementById('chatList');
            const chatbox = document.getElementById('chatbox');
            const header = document.querySelector('.header1');

            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                chatList.classList.add('collapsed');
                chatbox.classList.add('collapsed');
                header.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
            }

            toggleBtn.addEventListener('click', () => {
                chatList.classList.toggle('collapsed');
                chatbox.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
                toggleBtn.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', chatList.classList.contains('collapsed'));
            });
        }

        // Theme Toggle Functionality
        let currentTheme = localStorage.getItem('theme') || 'dark';

        function setupTheme() {
            // Always read latest theme from localStorage
            currentTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            updateThemeLabel();
            console.log('âœ… setupTheme: Applied theme -', currentTheme);
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeLabel();
            console.log('âœ… toggleTheme: Changed to -', currentTheme);
        }

        function updateThemeLabel() {
            const label = document.getElementById('themeLabel');
            const icon = document.querySelector('#themeToggleBtn i');
            if (currentTheme === 'dark') {
                label.textContent = 'Dark';
                icon.className = 'fas fa-moon';
            } else {
                label.textContent = 'Light';
                icon.className = 'fas fa-sun';
            }
        }

        // Listen for theme changes from other pages/tabs
        window.addEventListener('storage', (e) => {
            if (e.key === 'theme') {
                currentTheme = e.newValue || 'dark';
                document.body.setAttribute('data-theme', currentTheme);
                updateThemeLabel();
            }
        });

        document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

        // Verification Modal Functions
        const allDepartments = ['WT', 'FT', 'P', 'LOG', 'OE', 'IT', 'Other'];

        async function refreshCurrentQuestion() {
            try {
                // Fetch the latest question data from API
                const res = await fetch('/api/get-all-verified-answers');
                const data = await res.json();
                const questions = data.results || data.answers || [];
                const question = questions.find(q => q.id === parseInt(currentQuestionId));
                
                if (question) {
                    currentQuestion = question;
                    console.log('âœ… Question data refreshed:', currentQuestion);
                    console.log('âœ… Updated requested_departments_list:', currentQuestion.requested_departments_list);
                } else {
                    console.warn('âš ï¸ Question not found in refresh');
                }
            } catch (e) {
                console.error('Error refreshing question:', e);
            }
        }

        async function showVerificationStatus() {
            try {
                // Reload verifications data AND refresh current question
                await loadVerifications();
                await refreshCurrentQuestion();
                
                console.log('ðŸ” Current Question:', currentQuestion);
                console.log('ðŸ” Requested Departments:', currentQuestion?.requested_departments_list);
                console.log('ðŸ” All Verifications:', verifications);
                
                // Get due date from question
                const dueDate = currentQuestion?.due_date ? new Date(currentQuestion.due_date) : null;
                const dueDateStr = dueDate ? dueDate.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }) : 'N/A';
                
                // Build verification status - check which departments have verified (verification_type === 'verification')
                // Use the department from requestedDepartments field in each verification
                const verifiedDepartments = {};
                verifications.forEach(v => {
                    console.log('ðŸ“‹ Processing verification:', {
                        id: v.id,
                        username: v.username,
                        verification_type: v.verification_type,
                        requestedDepartments: v.requestedDepartments,
                        createdAt: v.createdAt
                    });
                    
                    // Check if this verification has verification_type = 'verification' (verified by someone)
                    if (v.verification_type === 'verification' && v.requestedDepartments && v.requestedDepartments.length > 0) {
                        // The requestedDepartments contains the department that verified
                        v.requestedDepartments.forEach(dept => {
                            if (!verifiedDepartments[dept]) {
                                verifiedDepartments[dept] = {
                                    username: v.username,
                                    date: new Date(v.createdAt).toLocaleDateString('en-GB', {
                                        day: '2-digit',
                                        month: 'short'
                                    })
                                };
                                console.log(`   âœ… ${dept} VERIFIED by ${v.username}`);
                            }
                        });
                    }
                });

                console.log('âœ… Verified Departments:', verifiedDepartments);

                const timeline = document.getElementById('verificationTimeline');
                
                if (currentQuestion && currentQuestion.requested_departments_list && currentQuestion.requested_departments_list.length > 0) {
                    const requestedDepts = currentQuestion.requested_departments_list;
                    console.log('ðŸ“ Building timeline for ALL requested departments:', requestedDepts);
                    
                    timeline.innerHTML = requestedDepts.map(dept => {
                        if (verifiedDepartments[dept]) {
                            // This department has verified
                            console.log(`âœ… Showing ${dept} as VERIFIED`);
                            return `
                                <div class="timeline-item">
                                    <div class="timeline-icon">âœ…</div>
                                    <div class="timeline-content">
                                        <div class="timeline-dept">${dept}</div>
                                        <div class="timeline-status verified">âœ” Verified by ${verifiedDepartments[dept].username} (${verifiedDepartments[dept].date})</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // This department hasn't verified yet
                            console.log(`â³ Showing ${dept} as WAITING`);
                            return `
                                <div class="timeline-item">
                                    <div class="timeline-icon">ðŸŸ¡</div>
                                    <div class="timeline-content">
                                        <div class="timeline-dept">${dept}</div>
                                        <div class="timeline-status waiting">â³ Waiting (Due: ${dueDateStr})</div>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    console.warn('âš ï¸ No requested departments found');
                    timeline.innerHTML = '<p style="color: #b0b0b0; text-align: center;">No verification requests yet</p>';
                }

                document.getElementById('verificationModal').classList.add('show');
            } catch (e) {
                console.error('Error loading verification status:', e);
                const timeline = document.getElementById('verificationTimeline');
                timeline.innerHTML = '<p style="color: #ff6b6b; text-align: center;">Unable to load verification status. Please try again.</p>';
                document.getElementById('verificationModal').classList.add('show');
            }
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.remove('show');
        }

        function showRequestMoreReviewers() {
            const checkboxGroup = document.getElementById('deptCheckboxGroup');
            checkboxGroup.innerHTML = allDepartments.map(dept => `
                <div class="dept-checkbox">
                    <input type="checkbox" id="dept-${dept}" value="${dept}">
                    <label for="dept-${dept}">${dept}</label>
                </div>
            `).join('');

            document.getElementById('verificationModal').classList.remove('show');
            document.getElementById('requestReviewersModal').classList.add('show');
        }

        function closeRequestReviewersModal() {
            document.getElementById('requestReviewersModal').classList.remove('show');
        }

        async function submitRequestReviewers() {
            const checked = document.querySelectorAll('#deptCheckboxGroup input:checked');
            const departments = Array.from(checked).map(c => c.value);

            if (departments.length === 0) {
                alert('Please select at least one department');
                return;
            }

            try {
                const res = await fetch('/api/request-verifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId: currentQuestionId, departments })
                });

                if (res.ok) {
                    alert('Verification request sent to ' + departments.join(', '));
                    closeRequestReviewersModal();
                    // Reload question detail to show updated status
                    await loadQuestionDetail();
                    // Show updated verification status modal
                    await showVerificationStatus();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Failed to send request');
                }
            } catch (e) {
                console.error('Error sending request:', e);
                alert('Failed to send verification request');
            }
        }

        async function submitVerifyComment() {
            const commentInput = document.getElementById('commentInput');
            const deptSelect = document.getElementById('commentDept');
            const text = commentInput.value.trim();
            const department = deptSelect.value;

            if (!currentUserId) {
                showMessage('Please login to verify', 'error');
                return;
            }

            if (!department) {
                showMessage('Please select a department', 'error');
                return;
            }

            // Verify with rating = 1 (helpful/verified)
            try {
                const attachments = [];
                
                console.log('ðŸ“Ž Verify - Selected files:', selectedFiles.length);
                
                // Upload files if any
                if (selectedFiles.length > 0) {
                    console.log('ðŸ“¤ Verify - Uploading files...');
                    const formData = new FormData();
                    selectedFiles.forEach(file => {
                        console.log('Adding file to verify:', file.name, file.size);
                        formData.append('files', file);
                    });

                    const uploadRes = await fetch('/api/upload-comment-files', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Verify upload response status:', uploadRes.status);
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        console.log('Verify upload result:', uploadData);
                        attachments.push(...(uploadData.files || []));
                    } else {
                        console.error('Verify upload failed:', await uploadRes.text());
                    }
                } else {
                    console.log('âš ï¸ Verify - No files selected');
                }

                const res = await fetch('/api/submit-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestionId,
                        rating: 1,
                        comment: text || '',
                        department: department,
                        attachments: attachments
                    })
                });

                if (res.ok) {
                    showMessage('Verification submitted successfully!', 'success');
                    // Clear form
                    commentInput.value = '';
                    deptSelect.value = '';
                    selectedFiles = []; // Clear selected files
                    document.getElementById('attachmentPreview').innerHTML = ''; // Clear preview
                    document.getElementById('verifyCommentBtn').style.display = 'none';
                    // Reload everything to refresh verification status
                    await loadComments();
                    await loadVerifications(); // Reload verifications to update modal data
                    await loadQuestionDetail(); // Reload question to get updated status
                    // Reload AI answer with question ID and answer to update decision badge
                    if (currentQuestion) {
                        await loadAISuggestion(currentQuestionId, currentQuestion.answer);
                    }
                } else {
                    const error = await res.json();
                    showMessage(error.error || 'Failed to submit verification', 'error');
                }
            } catch (e) {
                console.error('Error submitting verification:', e);
                showMessage('Error submitting verification. Please try again.', 'error');
            }
        }

        async function submitVerification() {
            if (!currentUserId) {
                alert('Please log in to verify this answer');
                return;
            }

            // Get selected departments
            const selectedDepts = getSelectedVerificationDepartments();
            if (selectedDepts.length === 0) {
                alert('Please select at least one department');
                return;
            }

            const ratingBtns = document.querySelectorAll('.verify-btn');
            let selectedRating = null;

            for (const btn of ratingBtns) {
                if (btn.classList.contains('selected')) {
                    selectedRating = parseInt(btn.getAttribute('data-rating'));
                    break;
                }
            }

            if (selectedRating === null) {
                alert('Please select a rating (Helpful/Neutral/Not Helpful)');
                return;
            }

            const comment = document.getElementById('verificationComment')?.value || '';

            try {
                const res = await fetch('/api/submit-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestionId,
                        rating: selectedRating,
                        comment: comment,
                        departments: selectedDepts
                    })
                });

                if (res.ok) {
                    alert('Thank you! Your verification has been submitted.');
                    // Reset form
                    document.querySelectorAll('.verify-btn').forEach(btn => btn.classList.remove('selected'));
                    document.getElementById('verificationComment').value = '';
                    // Reload to show updated verification status
                    await loadQuestionDetail();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Failed to submit verification');
                }
            } catch (e) {
                console.error('Error submitting verification:', e);
                alert('Failed to submit verification');
            }
        }

        document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

        // Utility Functions
        function formatDate(d) {
            if (!d) return 'unknown';
            const date = new Date(d);
            if (isNaN(date)) return 'unknown';
            const diff = Date.now() - date, 
                  m = Math.floor(diff/60000), 
                  h = Math.floor(diff/3600000), 
                  dy = Math.floor(diff/86400000);
            return m < 1 ? 'just now' : m < 60 ? m + 'm ago' : h < 24 ? h + 'h ago' : dy < 30 ? dy + 'd ago' : date.toLocaleDateString();
        }
    </script>

    <!-- Verification Status Modal -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Verification Status</h3>
                <button class="modal-close" onclick="closeVerificationModal()">&times;</button>
            </div>
            <div class="verification-timeline" id="verificationTimeline"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="showRequestMoreReviewers()">Request more reviewers</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeVerificationModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Request More Reviewers Modal -->
    <div id="requestReviewersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Request More Reviewers</h3>
                <button class="modal-close" onclick="closeRequestReviewersModal()">&times;</button>
            </div>
            <p style="color: #b0b0b0; font-size: 13px;">Select departments to request verification from:</p>
            <div class="dept-checkbox-group" id="deptCheckboxGroup"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="submitRequestReviewers()">Send Request</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeRequestReviewersModal()">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>
